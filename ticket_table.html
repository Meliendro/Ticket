<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Ticket Table</title>
<script src="https://cdn.tailwindcss.com"></script>
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
<style>
  body { font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif; background:#f5f5f5; }
  table { width:100%; border-collapse:collapse; }
  th, td { border:1px solid #ddd; padding:8px; text-align:center; }
  th { background:#ef4444; color:white; }
  .btn { cursor:pointer; padding:6px 12px; border-radius:6px; color:white; background:#3b82f6; }
  .priority-alta { background:#ef4444; color:white; padding:2px 6px; border-radius:4px; }
  .priority-media { background:#facc15; color:white; padding:2px 6px; border-radius:4px; }
  .priority-bassa { background:#22c55e; color:white; padding:2px 6px; border-radius:4px; }
</style>
</head>
<body class="p-6">

<div class="flex justify-between items-center mb-4">
  <h1 class="text-2xl font-bold">Ticket Table</h1>
  <div class="flex gap-2">
    <button class="btn" onclick="openConfig()">⚙️ Config</button>
    <button class="btn" onclick="window.open('ticket_form.html','_blank')">+ New Ticket</button>
  </div>
</div>

<table id="ticketTable">
  <thead>
    <tr>
      <th>Modifica</th>
      <th>Nr Ticket</th>
      <th>Stato</th>
      <th>Tipo</th>
      <th>Bloccante</th>
      <th>Priorità</th>
      <th>Data Inserimento</th>
      <th>Ambito</th>
      <th>Menu</th>
      <th>Titolo</th>
      <th>Descrizione</th>
      <th>Inserito da</th>
      <th>In carico a</th>
      <th>Data inizio prevista attività</th>
      <th>Data prevista fine attività</th>
      <th>Data rilascio</th>
      <th>Descrizione attività di soluzione</th>
      <th>Data Segnalato</th>
      <th>Data Preso in carico</th>
      <th>Data In Test</th>
      <th>Data Completato</th>
    </tr>
  </thead>
  <tbody>
    <!-- Ticket rows saranno generate qui -->
  </tbody>
</table>

<script>
// PIN configurazione
const CONFIG_PIN = "1234";

// Configurazione GitHub
let config = JSON.parse(localStorage.getItem('ticket_config')) || { token:"", repo:"", path:"ticket/2026/ticket2026.json" };
let tickets = [];

// Apri form configurazione
function openConfig(){
    const pin = prompt("Inserisci PIN di configurazione:");
    if(pin!==CONFIG_PIN){ alert("PIN errato"); return; }
    const token = prompt("GitHub Token:", config.token);
    const repo = prompt("Repository (user/repo):", config.repo);
    const path = prompt("Path JSON:", config.path);
    if(token && repo && path){
        config = {token, repo, path};
        localStorage.setItem('ticket_config', JSON.stringify(config));
        alert("Configurazione salvata!");
        loadTickets();
    }
}

// Carica tickets da GitHub
async function loadTickets(){
    if(!config.token || !config.repo || !config.path){ alert("Configurare GitHub per visualizzare i ticket"); return; }
    const url = `https://api.github.com/repos/${config.repo}/contents/${config.path}`;
    try {
        const res = await fetch(url, { headers:{ "Authorization": `token ${config.token}` } });
        if(res.ok){
            const data = await res.json();
            tickets = JSON.parse(atob(data.content));
            renderTable();
        } else { alert("Errore caricamento ticket"); }
    } catch(e){ console.error(e); alert("Errore di connessione a GitHub"); }
}

// Render della tabella
function renderTable(){
    const tbody = document.querySelector("#ticketTable tbody");
    tbody.innerHTML = "";
    tickets.forEach((t,i)=>{
        const tr = document.createElement("tr");
        tr.innerHTML = `
          <td><button onclick="editTicket(${i})" class="btn"><i class="fas fa-edit"></i></button></td>
          <td>${t.nrTicket}</td>
          <td>${t.stato||""}</td>
          <td>${t.tipo||""}</td>
          <td>${t.bloccante||""}</td>
          <td class="${t.priorita=='Alta'?'priority-alta':t.priorita=='Media'?'priority-media':'priority-bassa'}">${t.priorita||""}</td>
          <td>${t.dataInserimento||""}</td>
          <td>${t.ambito||""}</td>
          <td>${t.menu||""}</td>
          <td>${t.titolo||""}</td>
          <td>${t.descrizione||""}</td>
          <td>${t.inseritoDa||""}</td>
          <td>${t.inCaricoA||""}</td>
          <td>${t.dataInizioPrevista||""}</td>
          <td>${t.dataFinePrevista||""}</td>
          <td>${t.dataRilascio||""}</td>
          <td>${t.descrizioneSoluzione||""}</td>
          <td>${t.dataSegnalato||""}</td>
          <td>${t.dataPresoInCarico||""}</td>
          <td>${t.dataInTest||""}</td>
          <td>${t.dataCompletato||""}</td>
        `;
        tbody.appendChild(tr);
    });
}

// Modifica ticket
function editTicket(index){
    localStorage.setItem("editTicketIndex", index);
    window.open("ticket_form.html","_blank");
}

// Caricamento iniziale
loadTickets();
</script>

</body>
</html>
