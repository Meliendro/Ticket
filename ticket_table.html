<!DOCTYPE html>
<html lang="it">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Ticket Management OS</title>

<script src="https://cdn.tailwindcss.com"></script>
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">

<style>
    @import url('https://fonts.googleapis.com/css2?family=SF+Pro+Display:wght@300;400;500;600;700&display=swap');

    :root {
        --apple-blue: #007aff;
        --apple-red: #ff3b30;
        --apple-green: #34c759;
        --apple-bg: #f5f5f7;
    }

    body { 
        font-family: 'SF Pro Display', -apple-system, sans-serif; 
        background-color: var(--apple-bg);
        color: #1d1d1f;
        margin: 0;
        height: 100vh;
        overflow: hidden;
        display: flex;
    }

    /* Sidebar Navigation */
    .sidebar {
        width: 260px;
        background: rgba(255, 255, 255, 0.6);
        backdrop-filter: blur(30px);
        -webkit-backdrop-filter: blur(30px);
        border-right: 1px solid rgba(0,0,0,0.05);
        display: flex;
        flex-direction: column;
        padding: 2rem 1.5rem;
    }

    .nav-item {
        display: flex;
        align-items: center;
        padding: 0.8rem 1rem;
        border-radius: 12px;
        color: #424245;
        font-weight: 500;
        margin-bottom: 0.5rem;
        transition: all 0.2s;
        cursor: pointer;
    }

    .nav-item.active {
        background: white;
        color: var(--apple-blue);
        box-shadow: 0 4px 12px rgba(0,0,0,0.05);
    }

    /* Main Content */
    .main-content {
        flex: 1;
        display: flex;
        flex-direction: column;
        overflow: hidden;
    }

    .top-bar {
        padding: 1.5rem 2.5rem;
        display: flex;
        justify-content: space-between;
        align-items: center;
        background: rgba(245, 245, 247, 0.8);
        backdrop-filter: blur(10px);
    }

    /* Summary Stats Cards */
    .stat-card {
        background: white;
        padding: 1rem 1.5rem;
        border-radius: 18px;
        border: 1px solid rgba(0,0,0,0.03);
        box-shadow: 0 2px 10px rgba(0,0,0,0.02);
        min-width: 160px;
    }

    /* Table Styling */
    .table-wrapper {
        flex: 1;
        margin: 0 2.5rem 2.5rem 2.5rem;
        background: white;
        border-radius: 24px;
        box-shadow: 0 10px 40px rgba(0,0,0,0.06);
        border: 1px solid rgba(0,0,0,0.04);
        display: flex;
        flex-direction: column;
        overflow: hidden;
    }

    .table-scroll {
        overflow: auto;
        flex: 1;
    }

    table { width: 100%; border-collapse: separate; border-spacing: 0; min-width: 2500px; }

    th { 
        position: sticky; top: 0; z-index: 10;
        background: #fbfbfd;
        color: #86868b;
        font-size: 0.7rem;
        text-transform: uppercase;
        letter-spacing: 0.05em;
        padding: 1rem;
        border-bottom: 1px solid #f2f2f2;
        text-align: left;
    }

    td { 
        padding: 1rem; 
        border-bottom: 1px solid #f5f5f7;
        font-size: 0.85rem;
    }

    tr:hover td { background-color: #f9f9fb; }

    /* Custom Logic Classes */
    .ritardo-row td { background-color: rgba(255, 59, 48, 0.04) !important; }
    .ritardo-row td:first-child { border-left: 4px solid var(--apple-red); }
    .locked-row { opacity: 0.6; filter: grayscale(0.5); }

    .priority-badge {
        padding: 4px 10px;
        border-radius: 8px;
        font-size: 0.7rem;
        font-weight: 700;
        text-transform: uppercase;
    }
    .priority-alta { background: #fee2e2; color: #ef4444; }
    .priority-media { background: #fef3c7; color: #d97706; }
    .priority-bassa { background: #dcfce7; color: #16a34a; }

    /* Forms & Buttons */
    .apple-select {
        background: rgba(0,0,0,0.03);
        border: none;
        border-radius: 10px;
        padding: 0.5rem 1rem;
        font-size: 0.85rem;
        outline: none;
        cursor: pointer;
    }

    .btn-add {
        background: var(--apple-blue);
        color: white;
        padding: 0.7rem 1.4rem;
        border-radius: 12px;
        font-weight: 600;
        transition: all 0.2s;
    }
    .btn-add:hover { transform: scale(1.02); box-shadow: 0 5px 15px rgba(0,122,255,0.3); }

    .status-Segnalato { color: var(--apple-red); font-weight: 600; }
    .status-Preso { color: #f59e0b; font-weight: 600; }
    .status-Rilasciato { color: var(--apple-blue); font-weight: 600; }
    .status-Completato { color: var(--apple-green); font-weight: 600; }

    ::-webkit-scrollbar { width: 8px; height: 8px; }
    ::-webkit-scrollbar-thumb { background: #d2d2d7; border-radius: 10px; }
</style>
</head>

<body>

<aside class="sidebar">
    <div class="mb-10 px-2">
        <h2 class="text-xl font-bold tracking-tight">TicketHub <span class="text-blue-500">2026</span></h2>
    </div>
    
    <nav class="flex-1">
        <div class="nav-item active">
            <i class="fas fa-table mr-3"></i> Tabella Ticket
        </div>
        <div class="nav-item" onclick="window.location.href='ticket_gantt.html'">
            <i class="fas fa-chart-gantt mr-3"></i> Vista Gantt
        </div>
        <div class="nav-item">
            <i class="fas fa-chart-pie mr-3"></i> Statistiche
        </div>
    </nav>

    <div class="mt-auto px-2">
        <button onclick="configureGitHub()" class="text-xs text-gray-400 hover:text-gray-600 transition">
            <i class="fas fa-cog mr-1"></i> Impostazioni GitHub
        </button>
    </div>
</aside>

<main class="main-content">
    
    <header class="top-bar">
        <div class="flex gap-6">
            <div class="stat-card">
                <p class="text-[10px] text-gray-400 uppercase font-bold tracking-wider">Totali</p>
                <h3 id="statTotal" class="text-2xl font-bold">--</h3>
            </div>
            <div class="stat-card border-l-4 border-l-red-500">
                <p class="text-[10px] text-gray-400 uppercase font-bold tracking-wider">In Ritardo</p>
                <h3 id="statDelay" class="text-2xl font-bold text-red-500">--</h3>
            </div>
            <div class="stat-card border-l-4 border-l-green-500">
                <p class="text-[10px] text-gray-400 uppercase font-bold tracking-wider">Completati</p>
                <h3 id="statDone" class="text-2xl font-bold text-green-500">--</h3>
            </div>
        </div>

        <button onclick="newTicket()" class="btn-add">
            <i class="fas fa-plus mr-2"></i> Nuovo Ticket
        </button>
    </header>

    <div class="px-10 py-4 flex gap-3 items-center">
        <select id="filterStato" class="apple-select"><option value="">Tutti gli Stati</option></select>
        <select id="filterTipo" class="apple-select"><option value="">Tutti i Tipi</option></select>
        <select id="filterAmbito" class="apple-select"><option value="">Tutti gli Ambiti</option></select>
        <div class="flex-1"></div>
        <select id="filterCompletati" class="apple-select">
            <option value="nascondi">Nascondi completati</option>
            <option value="mostra">Mostra tutti</option>
        </select>
    </div>

    <div class="table-wrapper">
        <div class="table-scroll">
            <table id="ticketTable">
                <thead>
                    <tr>
                        <th class="w-20 text-center">Azioni</th>
                        <th class="w-24">Nr</th>
                        <th class="w-40">Stato</th>
                        <th class="w-40">Tipo</th>
                        <th class="w-32 text-center">Priorità</th>
                        <th class="w-40">Data Ins.</th>
                        <th class="w-40">Ambito</th>
                        <th class="w-60">Titolo</th>
                        <th class="w-[500px]">Descrizione</th>
                        <th class="w-40">Assegnato</th>
                        <th class="w-32 text-center">Fine Prev.</th>
                        <th class="w-[400px]">Attività</th>
                        <th class="w-32">Rilascio</th>
                    </tr>
                </thead>
                <tbody id="ticketBody"></tbody>
            </table>
        </div>
    </div>
</main>

<script>
// --- LOGICA ORIGINALE INALTERATA ---
let config = JSON.parse(localStorage.getItem('gh_ticket_config'));
let tickets = [];
let filters = { completati:"nascondi" };

function decodeUTF8(s){
    try { return decodeURIComponent(escape(atob(s))); } catch(e){ return "Errore"; }
}

async function loadTickets() {
    if(!config) { alert("⚠️ Configurare GitHub"); return; }
    const res = await fetch(`https://api.github.com/repos/${config.repo}/contents/ticket/2026/ticket2026.json`, {
        headers: {Authorization:`token ${config.token}`}
    });
    const data = await res.json();
    tickets = JSON.parse(decodeUTF8(data.content));
    updateStats();
    renderTable();
}

function updateStats() {
    const oggi = new Date();
    oggi.setHours(0,0,0,0);
    const ritardi = tickets.filter(t => t.dataFinePrevista && t.stato !== "Completato" && new Date(t.dataFinePrevista) < oggi).length;
    const completati = tickets.filter(t => !!t.dataCompletamentoSviluppo).length;
    
    document.getElementById('statTotal').innerText = tickets.length;
    document.getElementById('statDelay').innerText = ritardi;
    document.getElementById('statDone').innerText = completati;
}

document.getElementById("filterCompletati").onchange = (e)=>{
    filters.completati = e.target.value;
    renderTable();
};

function renderTable() {
    const tbody = document.getElementById('ticketBody');
    tbody.innerHTML = "";
    const oggi = new Date();
    oggi.setHours(0,0,0,0);

    tickets.sort((a,b)=>b.nrTicket - a.nrTicket).forEach((t,i)=>{
        if(filters.completati==="nascondi" && t.dataCompletamentoSviluppo) return;

        const isLocked = !!t.dataCompletamentoSviluppo;
        let isInRitardo = false;
        if (t.dataFinePrevista && t.stato !== "Completato") {
            const scadenza = new Date(t.dataFinePrevista);
            if (scadenza < oggi) isInRitardo = true;
        }

        const tr = document.createElement('tr');
        if(isLocked) tr.classList.add("locked-row");
        if(isInRitardo) tr.classList.add("ritardo-row");

        const lockIcon = isLocked ? '<i class="fas fa-lock text-gray-400 ml-1"></i>' : '';
        const btnClass = isLocked ? 'opacity-20 cursor-not-allowed' : 'text-blue-500 hover:scale-110 transition';

        tr.innerHTML = `
            <td class="text-center">
                <button onclick="${isLocked ? '' : 'editTicket('+i+')'}" class="${btnClass}">
                    <i class="fas fa-pen-to-square"></i>
                </button>
            </td>
            <td><span class="font-bold">#${t.nrTicket}</span> ${lockIcon}</td>
            <td class="status-${(t.stato||"").replace(/\s/g,'')}">${t.stato||""}</td>
            <td><span class="text-[11px] bg-gray-100 px-2 py-1 rounded text-gray-500 uppercase font-bold">${t.tipo||""}</span></td>
            <td class="text-center"><span class="priority-badge priority-${(t.priorita||'').toLowerCase()}">${t.priorita||''}</span></td>
            <td class="text-gray-400 text-xs">${t.dataInserimento||''}</td>
            <td><span class="font-medium text-slate-600">${t.ambito||''}</span></td>
            <td class="font-semibold">${t.titolo||''}</td>
            <td class="text-xs text-gray-500 leading-relaxed">${(t.descrizione||"").replace(/\n/g,'<br>')}</td>
            <td class="font-medium text-blue-600">${t.inCaricoA||''}</td>
            <td class="text-center text-xs font-bold ${isInRitardo ? 'text-red-500' : ''}">${t.dataFinePrevista||''}</td>
            <td class="text-xs text-gray-400 italic">${(t.descrAttivita||"").substring(0,100)}...</td>
            <td class="text-xs font-bold">${t.dataRilascio||''}</td>
        `;
        tbody.appendChild(tr);
    });
}

function newTicket() {
    localStorage.removeItem('edit_ticket');
    window.open("ticket_form.html","_blank","width=800,height=900");
}

function editTicket(index){
    localStorage.setItem('edit_ticket', JSON.stringify(tickets[index]));
    window.open("ticket_form.html","_blank","width=800,height=900");
}

function configureGitHub() {
    const repo = prompt("Repo (user/repo):", config?.repo || "");
    const token = prompt("Token:", config?.token || "");
    if(repo && token) {
        localStorage.setItem('gh_ticket_config', JSON.stringify({repo, token}));
        location.reload();
    }
}

const tableChannel = new BroadcastChannel('ticket_ytable');
tableChannel.onmessage = (e)=>{
    if(e.data && e.data.action==='reload') loadTickets();
};

loadTickets();
</script>

</body>
</html>
