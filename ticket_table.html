<!DOCTYPE html>
<html lang="it">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Ticket Table</title>
<script src="https://cdn.tailwindcss.com"></script>
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
<style>
body { font-family: 'Segoe UI', sans-serif; background: linear-gradient(135deg,#1e293b,#0f172a); min-height:100vh; }
.table-card { background: rgba(255,255,255,0.95); backdrop-filter: blur(10px); padding:1rem; border-radius:1rem; }
table { width:100%; border-collapse: collapse; }
th, td { padding:0.5rem; border-bottom:1px solid #d1d5db; font-size:0.9rem; }
th { background:#f3f4f6; font-weight:700; }
button { padding:0.25rem 0.5rem; border-radius:0.25rem; cursor:pointer; }
</style>
</head>
<body class="p-6">

<div class="table-card">
<h1 class="text-xl font-bold mb-4 text-gray-800">Lista Ticket</h1>
<table id="ticketTable">
<thead>
<tr>
<th>Nr</th>
<th>Titolo</th>
<th>Stato</th>
<th>Priorit√†</th>
<th>Data Inserimento</th>
<th>Azioni</th>
</tr>
</thead>
<tbody>
<tr><td colspan="6" class="text-center text-gray-500">Caricamento...</td></tr>
</tbody>
</table>
</div>

<script>
let config = JSON.parse(localStorage.getItem('gh_ticket_config')) || {};
let tickets = [];

function decodeUTF8(s){ try{return decodeURIComponent(escape(atob(s)));} catch(e){return "Errore";} }

async function loadTickets(){
    if(!config.repo || !config.token) return;
    try{
        const res = await fetch(`https://api.github.com/repos/${config.repo}/contents/ticket/2026/ticket2026.json`, {
            headers: { Authorization: `token ${config.token}` }
        });
        if(!res.ok) throw new Error("Errore caricamento ticket");
        const data = await res.json();
        tickets = JSON.parse(decodeUTF8(data.content));
        renderTable();
    }catch(e){ console.error("Errore:", e); }
}

function renderTable(){
    const tbody = document.querySelector('#ticketTable tbody');
    tbody.innerHTML = "";
    if(!tickets.length){
        tbody.innerHTML = '<tr><td colspan="6" class="text-center text-gray-500">Nessun ticket trovato</td></tr>';
        return;
    }
    tickets.forEach(t=>{
        const tr = document.createElement('tr');
        tr.innerHTML = `
            <td>${t.nrTicket}</td>
            <td>${t.titolo||''}</td>
            <td>${t.stato||''}</td>
            <td>${t.priorita||''}</td>
            <td>${t.dataInserimento||''}</td>
            <td>
                <button onclick="editTicket(${t.nrTicket})" class="bg-blue-600 text-white"><i class="fas fa-edit"></i></button>
                <button onclick="deleteTicket(${t.nrTicket})" class="bg-red-600 text-white"><i class="fas fa-trash"></i></button>
            </td>
        `;
        tbody.appendChild(tr);
    });
}

function editTicket(nr){
    const t = tickets.find(tt=>tt.nrTicket===nr);
    if(!t) return;
    localStorage.setItem('edit_ticket', JSON.stringify(t));
    window.open('ticket_form.html','_blank','width=900,height=800');
}

async function deleteTicket(nr){
    if(!confirm("Eliminare questo ticket?")) return;
    const index = tickets.findIndex(tt=>tt.nrTicket===nr);
    if(index===-1) return;
    tickets.splice(index,1);
    // salva su GitHub
    try{
        const res = await fetch(`https://api.github.com/repos/${config.repo}/contents/ticket/2026/ticket2026.json`, {
            headers:{ Authorization: `token ${config.token}` }
        });
        const data = await res.json();
        await fetch(`https://api.github.com/repos/${config.repo}/contents/ticket/2026/ticket2026.json`, {
            method:"PUT",
            headers:{ Authorization: `token ${config.token}`, "Content-Type":"application/json" },
            body: JSON.stringify({ message:`Delete Ticket #${nr}`, content:btoa(unescape(encodeURIComponent(JSON.stringify(tickets,null,2)))), sha:data.sha })
        });
        renderTable();
    }catch(e){ console.error("Errore:", e);}
}

// --- AGGIUNTA: BroadcastChannel per aggiornamento automatico ---
const tableChannel = new BroadcastChannel('ticket_ytable');
tableChannel.onmessage = (e) => {
    if(e.data && e.data.action==='reload'){
        loadTickets();
    }
};

loadTickets();
</script>
</body>
</html>
