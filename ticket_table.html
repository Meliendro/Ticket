<!DOCTYPE html>
<html lang="it">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Ticket Table - v2.1</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <style>
        body { font-family: 'Segoe UI', sans-serif; background: #f4f4f5; }
        .table-container { overflow-x: auto; margin-top: 1rem; background: white; }
        table { width: 100%; border-collapse: collapse; table-layout: fixed; min-width: 2500px; }
        th, td { padding: 0.6rem 0.8rem; text-align: left; vertical-align: top; border-bottom: 1px solid #e5e7eb; }
        th { background: #1f2937; color: #fff; position: sticky; top: 0; z-index: 10; }
        tr:nth-child(even) { background: #f9fafb; }
        
        .priority-alta { background: #dc2626 !important; color: #fff; font-weight: bold; text-align: center; border-radius:4px; }
        .priority-media { background: #f59e0b !important; color: #fff; font-weight: bold; text-align: center; border-radius:4px; }
        .priority-bassa { background: #10b981 !important; color: #fff; font-weight: bold; text-align: center; border-radius:4px; }
        
        .status-Segnalato { color: #ef4444; font-weight: bold; }
        .status-Preso { color: #f59e0b; font-weight: bold; }
        .status-Rilasciato { color: #3b82f6; font-weight: bold; }
        .status-InTest { color: #6366f1; font-weight: bold; }
        .status-Completato { color: #10b981; font-weight: bold; }
        
        /* Evidenziazione Scadenza */
        .expired-cell { background-color: #ef4444 !important; color: white !important; font-weight: 900 !important; text-align: center; border-radius: 4px; box-shadow: inset 0 0 4px rgba(0,0,0,0.2); }

        .col-desc { width: 500px; } 
        .col-desc-act { width: 400px; }
        .col-small { width: 90px; }
        .col-medium { width: 150px; }
        .col-date { width: 130px; }

        td.wrap-text, td.wrap-text-act { white-space: normal; word-break: break-word; font-size: 0.85rem; color: #374151; }
    </style>
</head>
<body class="p-6">

<header class="flex justify-between items-center mb-4">
    <div class="flex items-center gap-4">
        <h1 class="text-2xl font-bold text-slate-800">Gestione Ticket</h1>
        <span id="syncStatus" class="text-xs px-2 py-1 rounded bg-gray-200 text-gray-600">In attesa...</span>
    </div>
    <div class="flex gap-3">
        <button onclick="newTicket()" class="bg-blue-600 text-white px-4 py-2 rounded shadow hover:bg-blue-700 transition">
            <i class="fas fa-plus"></i> Nuovo Ticket
        </button>
        <button onclick="configureGitHub()" class="bg-gray-700 text-white px-4 py-2 rounded shadow hover:bg-gray-800 transition">
            <i class="fas fa-cog"></i> Config
        </button>
    </div>
</header>

<div class="flex gap-4 mb-4 bg-white p-3 rounded-lg shadow-sm border border-gray-200" id="filterBar">
    <select id="filterStato" class="border p-1 rounded text-sm outline-none"><option value="">Stati: Tutti</option></select>
    <select id="filterTipo" class="border p-1 rounded text-sm outline-none"><option value="">Tipi: Tutti</option></select>
    <select id="filterAmbito" class="border p-1 rounded text-sm outline-none"><option value="">Ambiti: Tutti</option></select>
</div>

<div class="table-container border rounded-xl shadow-xl">
    <table id="ticketTable">
        <thead>
            <tr>
                <th class="col-small">Azioni</th>
                <th class="col-small">Nr</th>
                <th class="col-medium">Stato</th>
                <th class="col-medium">Tipo</th>
                <th class="col-medium">Bloccante</th>
                <th class="col-small">Priorità</th>
                <th class="col-date">Data Ins.</th>
                <th class="col-medium">Ambito</th>
                <th class="col-medium">Menu</th>
                <th class="col-medium">Titolo</th>
                <th class="col-desc">Descrizione</th> 
                <th class="col-medium">In carico</th>
                <th class="col-date text-orange-400">Scadenza</th>
                <th class="col-desc-act">Attività</th>
                <th class="col-date">Completato</th>
            </tr>
        </thead>
        <tbody id="ticketBody">
            <tr><td colspan="15" class="p-10 text-center text-gray-400">Caricamento dati in corso...</td></tr>
        </tbody>
    </table>
</div>

<script>
let config = JSON.parse(localStorage.getItem('gh_ticket_config'));
let tickets = [];
let filters = { stato: "", tipo: "", ambito: "" };

function decodeUTF8(s) {
    try { return decodeURIComponent(escape(atob(s))); } catch (e) { return "Errore decodifica"; }
}

function configureGitHub() {
    const pin = prompt("Inserisci PIN (1234):");
    if(pin === "1234"){
        const repo = prompt("Repository (es: meliendro/ticket):", config?.repo || "");
        const token = prompt("Token GitHub:", config?.token || "");
        if(repo && token) {
            localStorage.setItem('gh_ticket_config', JSON.stringify({repo: repo.trim(), token: token.trim()}));
            location.reload();
        }
    }
}

async function loadTickets() {
    if(!config || !config.repo || !config.token) {
        document.getElementById('ticketBody').innerHTML = `<tr><td colspan="15" class="p-10 text-center text-orange-500 font-bold">⚠️ Configurazione mancante o errata. Clicca su Config.</td></tr>`;
        return;
    }
    
    const url = `https://api.github.com/repos/${config.repo}/contents/ticket/2026/ticket2026.json?nocache=${Date.now()}`;

    try {
        const res = await fetch(url, {
            headers: { 'Authorization': `token ${config.token}` }
        });
        
        if(!res.ok) throw new Error(`Status ${res.status}: ${res.statusText}`);
        
        const data = await res.json();
        tickets = JSON.parse(decodeUTF8(data.content));
        
        document.getElementById('syncStatus').textContent = "Sincronizzato";
        document.getElementById('syncStatus').className = "text-xs px-2 py-1 rounded bg-green-100 text-green-700";
        
        populateFilterDropdowns();
        renderTable();
    } catch(e) {
        document.getElementById('ticketBody').innerHTML = `
            <tr><td colspan="15" class="p-10 text-red-600 bg-red-50">
                <p class="font-bold">❌ Impossibile caricare i ticket.</p>
                <p class="text-xs">Dettaglio Errore: ${e.message}</p>
                <p class="text-xs mt-2"><b>Possibili cause:</b><br>
                1. Il Token GitHub è scaduto o errato.<br>
                2. Il percorso 'ticket/2026/ticket2026.json' non esiste.<br>
                3. Il browser blocca la richiesta (prova a ricaricare).</p>
            </td></tr>`;
    }
}

function populateFilterDropdowns() {
    const fill = (id, key) => {
        const sel = document.getElementById(id);
        const current = sel.value;
        sel.innerHTML = `<option value="">${id.replace('filter','').replace('Stato','Stati').replace('Tipo','Tipi').replace('Ambito','Ambiti')}: Tutti</option>`;
        const values = [...new Set(tickets.map(t => t[key]))].filter(Boolean).sort();
        values.forEach(v => {
            const opt = document.createElement("option");
            opt.value = v; opt.textContent = v;
            if(v === current) opt.selected = true;
            sel.appendChild(opt);
        });
        sel.onchange = (e) => { filters[key] = e.target.value; renderTable(); };
    };
    fill("filterStato", "stato");
    fill("filterTipo", "tipo");
    fill("filterAmbito", "ambito");
}

function renderTable() {
    const tbody = document.getElementById('ticketBody');
    tbody.innerHTML = "";
    
    const today = new Date();
    today.setHours(0,0,0,0);

    const filtered = tickets.filter(t => {
        return (!filters.stato || t.stato === filters.stato) &&
               (!filters.tipo || t.tipo === filters.tipo) &&
               (!filters.ambito || t.ambito === filters.ambito);
    });

    filtered.sort((a,b) => b.nrTicket - a.nrTicket).forEach((t) => {
        // LOGICA SCADENZA
        let scadenzaClass = "";
        if (t.dataFinePrevista && t.stato !== "Completato") {
            const dataFine = new Date(t.dataFinePrevista);
            if (dataFine < today) {
                scadenzaClass = "expired-cell";
            }
        }

        const tr = document.createElement('tr');
        tr.innerHTML = `
            <td class="text-center">
                <button onclick='editTicket(${JSON.stringify(t).replace(/'/g, "&apos;")})' class="bg-yellow-400 p-2 rounded text-xs hover:bg-yellow-500 shadow-sm"><i class="fas fa-edit"></i></button>
            </td>
            <td class="${scadenzaClass}">${t.nrTicket}</td>
            <td class="status-${(t.stato||'').replace(/\s/g,'')}">${t.stato||''}</td>
            <td>${t.tipo||''}</td>
            <td>${t.bloccante||''}</td>
            <td class="flex justify-center"><span class="priority-${(t.priorita||'').toLowerCase()} w-full py-1">${t.priorita||''}</span></td>
            <td>${t.dataInserimento||''}</td>
            <td>${t.ambito||''}</td>
            <td>${t.menu||''}</td>
            <td>${t.titolo||''}</td>
            <td class="wrap-text">${(t.descrizione||'').substring(0,120)}...</td>
            <td>${t.inCaricoA||''}</td>
            <td>${t.dataFinePrevista||''}</td>
            <td class="wrap-text-act">${(t.descrAttivita||'')}</td>
            <td>${t.dataCompletato||''}</td>
        `;
        tbody.appendChild(tr);
    });
}

function newTicket() {
    localStorage.removeItem('edit_ticket');
    window.open("ticket_form.html", "_blank");
}

window.editTicket = function(ticketObj) {
    localStorage.setItem('edit_ticket', JSON.stringify(ticketObj));
    window.open("ticket_form.html", "_blank");
}

loadTickets();
</script>
</body>
</html>
