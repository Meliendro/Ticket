<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Ticket Table</title>
<script src="https://cdn.tailwindcss.com"></script>
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
<style>
body { font-family: 'Segoe UI', sans-serif; background: #f4f4f5; }
h1 { font-weight: 700; }
.table-container { overflow-x: auto; margin-top: 1rem; }
table { width: 100%; border-collapse: collapse; table-layout: auto; }
th, td { padding: 0.4rem 0.6rem; text-align: left; vertical-align: top; }
th { background: #1f2937; color: #fff; position: sticky; top: 0; }
tr:nth-child(even) { background: #f9fafb; }
.priority-alta { background: #dc2626; color: #fff; font-weight: bold; text-align: center; }
.priority-media { background: #f59e0b; color: #fff; font-weight: bold; text-align: center; }
.priority-bassa { background: #10b981; color: #fff; font-weight: bold; text-align: center; }
.status-Segnalato { color: #ef4444; font-weight: bold; }
.status-Preso { color: #f59e0b; font-weight: bold; }
.status-Rilasciato { color: #3b82f6; font-weight: bold; }
.status-InTest { color: #6366f1; font-weight: bold; }
.status-Completato { color: #10b981; font-weight: bold; }
button, select { cursor: pointer; }
.filter-bar { display:flex; flex-wrap:wrap; gap:0.5rem; margin-bottom:0.5rem; }
.filter-bar select { padding:0.25rem 0.5rem; border-radius:0.5rem; border:1px solid #d1d5db; background:#fff; color:#111827; font-size:0.9rem; transition:all 0.2s; }

/* Colonne descrizione larghe e leggibili */
td.wrap-text {
    white-space: normal;
    word-break: break-word;
    max-width: 2500px; /* colonna Descrizione molto larga */
}
td.wrap-text-act {
    white-space: normal;
    word-break: break-word;
    max-width: 1000px; /* colonna Descrizione Attività più larga */
}

/* Line-height e font per compattezza */
td, th { line-height: 1.3; font-size: 0.875rem; }
</style>
</head>
<body class="p-6">

<header class="flex justify-between items-center mb-2">
    <h1 class="text-2xl">Gestione Ticket</h1>
    <div class="flex gap-3">
        <button onclick="newTicket()" class="bg-blue-600 text-white px-4 py-2 rounded shadow hover:bg-blue-700"><i class="fas fa-plus"></i> Nuovo Ticket</button>
        <button onclick="configureGitHub()" class="bg-gray-600 text-white px-4 py-2 rounded shadow hover:bg-gray-700"><i class="fas fa-cog"></i> Config GitHub</button>
    </div>
</header>

<div class="filter-bar" id="filterBar">
    <select id="filterStato"><option value="">Tutti gli Stati</option></select>
    <select id="filterTipo"><option value="">Tutti i Tipi</option></select>
    <select id="filterBloccante"><option value="">Bloccante / Non Bloccante</option></select>
    <select id="filterAmbito"><option value="">Tutti gli Ambiti</option></select>
</div>

<div class="table-container border rounded shadow">
    <table id="ticketTable">
        <thead>
            <tr>
                <th>Modifica</th>
                <th>Nr Ticket</th>
                <th>Stato</th>
                <th>Tipo</th>
                <th>Bloccante</th>
                <th>Priorità</th>
                <th>Data Inserimento</th>
                <th>Ambito</th>
                <th>Menu</th>
                <th>Titolo</th>
                <th>Descrizione</th>
                <th>Inserito da</th>
                <th>In carico a</th>
                <th>Data Inizio Prevista</th>
                <th>Data Fine Prevista</th>
                <th>Data Rilascio</th>
                <th>Descrizione Attività</th>
                <th>Data Segnalato</th>
                <th>Data Preso In Carico</th>
                <th>Data Rilasciato</th>
                <th>Data In Test</th>
                <th>Data Completato</th>
            </tr>
        </thead>
        <tbody id="ticketBody"></tbody>
    </table>
</div>

<script>
let config = JSON.parse(localStorage.getItem('gh_ticket_config'));
let tickets = [];
let fileSha = "";
let filters = { stato:"", tipo:"", bloccante:"", ambito:"" };

function configureGitHub() {
    const pin = prompt("Inserisci PIN per configurazione:");
    if(pin === "1234"){
        const repo = prompt("Repo GitHub (es: user/repo)");
        const token = prompt("Token GitHub");
        localStorage.setItem('gh_ticket_config', JSON.stringify({repo, token}));
        config = {repo, token};
        alert("Configurazione salvata!");
    } else alert("PIN errato");
}

async function loadTickets() {
    if(!config) { alert("⚠️ Configurare GitHub per visualizzare i ticket"); return; }
    try {
        const res = await fetch(`https://api.github.com/repos/${config.repo}/contents/ticket/2026/ticket2026.json`, {
            headers: {Authorization:`token ${config.token}`}
        });
        if(!res.ok) throw new Error("Errore caricamento ticket");
        const data = await res.json();
        fileSha = data.sha;
        tickets = JSON.parse(atob(data.content));
        populateFilters();
        renderTable();
    } catch(e) { alert("Errore caricamento ticket: "+e.message); }
}

function populateFilters() {
    const selectStato = document.getElementById("filterStato");
    const selectTipo = document.getElementById("filterTipo");
    const selectBloccante = document.getElementById("filterBloccante");
    const selectAmbito = document.getElementById("filterAmbito");

    [...new Set(tickets.map(t=>t.stato))].forEach(s=>{ const opt=document.createElement("option"); opt.value=s; opt.text=s; selectStato.appendChild(opt); });
    [...new Set(tickets.map(t=>t.tipo))].forEach(s=>{ const opt=document.createElement("option"); opt.value=s; opt.text=s; selectTipo.appendChild(opt); });
    [...new Set(tickets.map(t=>t.bloccante))].forEach(s=>{ const opt=document.createElement("option"); opt.value=s; opt.text=s; selectBloccante.appendChild(opt); });
    [...new Set(tickets.map(t=>t.ambito))].forEach(s=>{ const opt=document.createElement("option"); opt.value=s; opt.text=s; selectAmbito.appendChild(opt); });

    selectStato.onchange = ()=>{ filters.stato = selectStato.value; renderTable(); };
    selectTipo.onchange = ()=>{ filters.tipo = selectTipo.value; renderTable(); };
    selectBloccante.onchange = ()=>{ filters.bloccante = selectBloccante.value; renderTable(); };
    selectAmbito.onchange = ()=>{ filters.ambito = selectAmbito.value; renderTable(); };
}

function renderTable() {
    const tbody = document.getElementById('ticketBody');
    tbody.innerHTML = "";
    tickets.sort((a,b)=>b.nrTicket - a.nrTicket).forEach((t,i)=>{
        if(filters.stato && t.stato!==filters.stato) return;
        if(filters.tipo && t.tipo!==filters.tipo) return;
        if(filters.bloccante && t.bloccante!==filters.bloccante) return;
        if(filters.ambito && t.ambito!==filters.ambito) return;

        const tr = document.createElement('tr');
        tr.innerHTML = `
        <td><button onclick="editTicket(${i})" class="bg-yellow-400 p-1 rounded hover:bg-yellow-500"><i class="fas fa-edit"></i></button></td>
        <td>${t.nrTicket}</td>
        <td class="status-${t.stato.replace(/\s/g,'')}">${t.stato}</td>
        <td>${t.tipo}</td>
        <td>${t.bloccante}</td>
        <td class="priority-${t.priorita.toLowerCase()}">${t.priorita}</td>
        <td>${t.dataInserimento}</td>
        <td>${t.ambito}</td>
        <td>${t.menu}</td>
        <td>${t.titolo}</td>
        <td class="wrap-text">${t.descrizione.replace(/\n/g,'<br>')}</td>
        <td>${t.inseritoDa}</td>
        <td>${t.inCaricoA}</td>
        <td>${t.dataInizioPrevista}</td>
        <td>${t.dataFinePrevista}</td>
        <td>${t.dataRilascio}</td>
        <td class="wrap-text-act">${t.descrAttivita.replace(/\n/g,'<br>')}</td>
        <td>${t.dataSegnalato||""}</td>
        <td>${t.dataPresoInCarico||""}</td>
        <td>${t.dataRilasciato||""}</td>
        <td>${t.dataInTest||""}</td>
        <td>${t.dataCompletato||""}</td>
        `;
        tbody.appendChild(tr);
    });
}

function newTicket() {
    localStorage.removeItem('edit_ticket');
    window.open("ticket_form.html","_blank","width=800,height=900");
}

function editTicket(index){
    localStorage.setItem('edit_ticket', JSON.stringify(tickets[index]));
    window.open("ticket_form.html","_blank","width=800,height=900");
}

loadTickets();
</script>
</body>
</html>
