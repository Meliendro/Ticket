<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Ticket Table</title>
<script src="https://cdn.tailwindcss.com"></script>
<style>
  body { font-family: 'Segoe UI', sans-serif; background: #f3f4f6; }
  .priority-alta { background-color: #f87171; color: white; }
  .priority-media { background-color: #fbbf24; color: black; }
  .priority-bassa { background-color: #34d399; color: white; }
  .locked { background-color: #e5e7eb; }
  table { width: 100%; border-collapse: collapse; margin-top: 1rem; }
  th, td { border: 1px solid #d1d5db; padding: 0.5rem; text-align: left; font-size: 0.85rem; }
  th { background-color: #f9fafb; }
  button { cursor: pointer; }
</style>
</head>
<body>
<div class="p-4 max-w-[1500px] mx-auto">
  <div class="flex justify-between items-center mb-4">
    <h1 class="text-2xl font-bold">Ticket Table</h1>
    <div class="flex gap-2">
      <button onclick="openForm()" class="px-4 py-2 bg-blue-600 text-white rounded-lg font-bold">Nuovo Ticket</button>
      <button onclick="configure()" class="px-4 py-2 bg-gray-600 text-white rounded-lg font-bold">⚙️ Config</button>
    </div>
  </div>
  
  <table id="ticketTable">
    <thead>
      <tr>
        <th>Modifica</th>
        <th>Nr Ticket</th>
        <th>Stato</th>
        <th>Tipo</th>
        <th>Bloccante</th>
        <th>Priorità</th>
        <th>Data Inserimento</th>
        <th>Ambito</th>
        <th>Menu</th>
        <th>Titolo</th>
        <th>Descrizione</th>
        <th>Inserito da</th>
        <th>In Carico a</th>
        <th>Data Inizio Prevista</th>
        <th>Data Fine Prevista</th>
        <th>Data Rilascio</th>
        <th>Descrizione Soluzione</th>
        <th>Data Segnalato</th>
        <th>Data Preso in Carico</th>
        <th>Data Rilasciato</th>
        <th>Data In Test</th>
        <th>Data Completato</th>
      </tr>
    </thead>
    <tbody></tbody>
  </table>
</div>

<script>
let config = JSON.parse(localStorage.getItem('ticket_config')) || {};
let tickets = [];

// Configurazione protetta da PIN
function configure(){
  let pin = prompt("Inserisci PIN per configurare accesso JSON");
  if(pin !== "1234") return alert("PIN errato");
  let repo = prompt("Inserisci repo GitHub");
  let token = prompt("Inserisci token");
  let path = prompt("Percorso file JSON (es: ticket/2026/ticket2026.json)");
  config = {repo, token, path};
  localStorage.setItem('ticket_config', JSON.stringify(config));
  alert("Configurazione salvata!");
}

// Apri form nuovo ticket
function openForm(ticket=null){
  let win = window.open("ticket_form.html","ticketForm","width=1000,height=900");
  if(ticket) win.ticketData = ticket;
  win.config = config;
}

// Carica ticket dal JSON
async function loadTickets(){
  const tbody = document.querySelector("#ticketTable tbody");
  tbody.innerHTML="";
  if(!config.repo || !config.token || !config.path){
    tbody.innerHTML="<tr><td colspan='22'>⚠️ Configurare GitHub per visualizzare i ticket</td></tr>";
    return;
  }
  try{
    const url = `https://api.github.com/repos/${config.repo}/contents/${config.path}`;
    const res = await fetch(url,{headers:{"Authorization":`token ${config.token}`}, cache:'no-store'});
    if(!res.ok) throw new Error("Errore caricamento ticket");
    const data = await res.json();
    tickets = JSON.parse(atob(data.content));
    tickets.forEach(t=>{
      const tr=document.createElement("tr");
      tr.innerHTML=`
        <td><button onclick='openForm(${JSON.stringify(t)})'>✏️</button></td>
        <td>${t.nrTicket}</td>
        <td>${t.stato}</td>
        <td>${t.tipo}</td>
        <td>${t.bloccante}</td>
        <td class="${t.priorita==="Alta"?"priority-alta":t.priorita==="Media"?"priority-media":"priority-bassa"}">${t.priorita}</td>
        <td>${t.dataInserimento}</td>
        <td>${t.ambito}</td>
        <td>${t.menu}</td>
        <td>${t.titolo}</td>
        <td>${t.descrizione}</td>
        <td>${t.inseritoDa}</td>
        <td>${t.inCaricoA}</td>
        <td>${t.dataInizioPrev}</td>
        <td>${t.dataFinePrev}</td>
        <td>${t.dataRilascio}</td>
        <td>${t.descrizioneSoluzione}</td>
        <td>${t.dataSegnalato||""}</td>
        <td>${t.dataPresoInCarico||""}</td>
        <td>${t.dataRilasciato||""}</td>
        <td>${t.dataInTest||""}</td>
        <td>${t.dataCompletato||""}</td>
      `;
      tbody.appendChild(tr);
    });
  } catch(e){
    tbody.innerHTML="<tr><td colspan='22'>Errore caricamento ticket</td></tr>";
    console.error(e);
  }
}

loadTickets();
</script>
</body>
</html>
