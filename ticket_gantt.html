<!DOCTYPE html>
<html lang="it">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Gantt Professional 2026 | OS Style</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <style>
        @import url('https://fonts.googleapis.com/css2?family=SF+Pro+Display:wght@300;400;600&display=swap');
        
        body {
            font-family: 'SF Pro Display', -apple-system, sans-serif;
            background: #f5f5f7;
            color: #1d1d1f;
            margin: 0;
            overflow: hidden;
        }

        /* Glassmorphism Containers */
        .main-container {
            height: 100vh;
            display: flex;
            flex-direction: column;
            padding: 24px;
        }

        .glass-card {
            background: rgba(255, 255, 255, 0.7);
            backdrop-filter: blur(20px);
            -webkit-backdrop-filter: blur(20px);
            border: 1px solid rgba(255, 255, 255, 0.4);
            border-radius: 24px;
            box-shadow: 0 8px 32px rgba(0,0,0,0.08);
            flex: 1;
            display: flex;
            flex-direction: column;
            overflow: hidden;
        }

        /* Gantt Structure */
        .gantt-grid-container {
            display: grid;
            grid-template-columns: 280px 1fr;
            flex: 1;
            overflow: hidden;
        }

        .sidebar {
            background: rgba(245, 245, 247, 0.5);
            border-right: 1px solid rgba(0,0,0,0.05);
            overflow-y: auto;
            z-index: 10;
        }

        .viewport {
            overflow: auto;
            position: relative;
            background: white;
            cursor: grab;
        }

        .viewport:active { cursor: grabbing; }

        /* Header Timeline */
        .timeline-header {
            display: flex;
            height: 60px;
            background: rgba(255,255,255,0.9);
            position: sticky;
            top: 0;
            z-index: 20;
            border-bottom: 1px solid rgba(0,0,0,0.05);
        }

        .day-cell {
            min-width: 50px;
            flex-shrink: 0;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            font-size: 0.7rem;
            border-right: 1px solid rgba(0,0,0,0.03);
        }

        .day-cell.weekend { background: rgba(0,0,0,0.02); }
        .day-cell.today { background: rgba(0, 122, 255, 0.05); color: #007aff; font-weight: bold; }

        /* Gantt Rows */
        .gantt-row {
            height: 50px;
            border-bottom: 1px solid rgba(0,0,0,0.03);
            position: relative;
            display: flex;
            align-items: center;
        }

        .sidebar-row {
            height: 50px;
            padding: 0 16px;
            display: flex;
            flex-direction: column;
            justify-content: center;
            border-bottom: 1px solid rgba(0,0,0,0.03);
            font-size: 0.8rem;
        }

        /* Bars & Badges */
        .bar {
            position: absolute;
            height: 28px;
            border-radius: 14px;
            display: flex;
            align-items: center;
            padding: 0 12px;
            color: white;
            font-size: 0.75rem;
            font-weight: 600;
            box-shadow: 0 4px 12px rgba(0,0,0,0.1);
            white-space: nowrap;
            z-index: 5;
            transition: transform 0.2s ease;
        }

        .bar:hover { transform: scale(1.02); z-index: 15; }

        .delay-badge {
            background: #ff3b30;
            color: white;
            padding: 2px 8px;
            border-radius: 10px;
            font-size: 0.65rem;
            font-weight: 800;
            margin-left: 8px;
            animation: pulse 1.5s infinite;
        }

        @keyframes pulse {
            0% { opacity: 1; transform: scale(1); }
            50% { opacity: 0.7; transform: scale(0.95); }
            100% { opacity: 1; transform: scale(1); }
        }

        .today-line {
            position: absolute;
            top: 0;
            bottom: 0;
            width: 2px;
            background: #ff3b30;
            z-index: 10;
            pointer-events: none;
        }

        .today-line::after {
            content: 'OGGI';
            position: absolute;
            top: 0;
            left: -15px;
            background: #ff3b30;
            color: white;
            font-size: 0.6rem;
            padding: 2px 5px;
            border-radius: 3px;
        }

        /* Custom Scrollbar */
        ::-webkit-scrollbar { width: 6px; height: 6px; }
        ::-webkit-scrollbar-thumb { background: rgba(0,0,0,0.1); border-radius: 10px; }
    </style>
</head>
<body>

<div class="main-container">
    <div class="flex justify-between items-center mb-6">
        <div>
            <h1 class="text-3xl font-black tracking-tight text-slate-900">Gantt Flow <span class="text-blue-600">2026</span></h1>
            <p class="text-slate-500 font-medium">Monitoraggio scadenze e ritardi operativi</p>
        </div>
        <div class="flex gap-3">
            <button onclick="loadData()" class="bg-white border border-slate-200 text-slate-700 px-5 py-2 rounded-full font-bold shadow-sm hover:bg-slate-50 transition">
                <i class="fas fa-sync-alt mr-2"></i>Aggiorna
            </button>
        </div>
    </div>

    <div class="glass-card">
        <div class="gantt-grid-container">
            <div class="sidebar" id="sidebar">
                <div class="h-[60px] flex items-center px-4 font-bold text-slate-400 text-xs uppercase border-bottom tracking-widest">Lista Ticket</div>
                <div id="sidebarContent"></div>
            </div>

            <div class="viewport" id="ganttViewport">
                <div class="timeline-header" id="timelineHeader"></div>
                <div id="ganttBody" class="relative"></div>
            </div>
        </div>
    </div>
</div>

<script>
    const config = JSON.parse(localStorage.getItem('gh_ticket_config'));
    const DAY_PX = 50;

    function parseDate(val) {
        if(!val) return null;
        if(val.includes("/")) {
            const [d,m,y] = val.split("/");
            return new Date(y, m-1, d);
        }
        return new Date(val);
    }

    function calculateDelay(endPrev, release) {
        if (release || !endPrev) return 0;
        const end = parseDate(endPrev);
        const today = new Date();
        today.setHours(0,0,0,0);
        if (end < today) {
            return Math.ceil((today - end) / (1000 * 60 * 60 * 24));
        }
        return 0;
    }

    async function loadData() {
        if(!config) return alert("Configurazione GitHub mancante!");
        try {
            const res = await fetch(`https://api.github.com/repos/${config.repo}/contents/ticket/2026/ticket2026.json?v=${Date.now()}`, {
                headers: { 'Authorization': `token ${config.token}` }
            });
            const data = await res.json();
            const tickets = JSON.parse(decodeURIComponent(escape(atob(data.content))));
            render(tickets);
        } catch(e) { console.error(e); }
    }

    function render(tickets) {
        const sidebar = document.getElementById('sidebarContent');
        const header = document.getElementById('timelineHeader');
        const body = document.getElementById('ganttBody');
        
        sidebar.innerHTML = ""; header.innerHTML = ""; body.innerHTML = "";

        // 1. ORDINAMENTO DECRESCENTE
        const sorted = tickets.sort((a,b) => b.nrTicket - a.nrTicket);

        // 2. Calcolo Range Temporale
        const allDates = sorted.map(t => parseDate(t.dataInizioPrevista) || parseDate(t.dataInserimento) || new Date());
        const minDate = new Date(Math.min(...allDates));
        minDate.setDate(minDate.getDate() - 7);
        const maxDate = new Date();
        maxDate.setDate(maxDate.getDate() + 30);

        const totalDays = Math.ceil((maxDate - minDate) / (1000*60*60*24));

        // 3. Render Header
        for(let i=0; i<=totalDays; i++) {
            const d = new Date(minDate); d.setDate(d.getDate() + i);
            const isToday = d.toDateString() === new Date().toDateString();
            const cell = document.createElement('div');
            cell.className = `day-cell ${d.getDay()===0||d.getDay()===6?'weekend':''} ${isToday?'today':''}`;
            cell.innerHTML = `<span>${d.toLocaleDateString('it-IT',{weekday:'short'}).charAt(0)}</span><span class="text-base">${d.getDate()}</span>`;
            header.appendChild(cell);
        }

        // 4. Render Rows
        sorted.forEach(t => {
            const start = parseDate(t.dataInizioPrevista) || parseDate(t.dataInserimento);
            const end = parseDate(t.dataFinePrevista) || start;
            const ritardo = calculateDelay(t.dataFinePrevista, t.dataRilascio);

            // Sidebar Row
            const sRow = document.createElement('div');
            sRow.className = "sidebar-row";
            sRow.innerHTML = `
                <div class="flex items-center justify-between">
                    <span class="font-bold text-slate-800">#${t.nrTicket}</span>
                    ${ritardo > 0 ? `<span class="delay-badge">RITARDO ${ritardo}G</span>` : ''}
                </div>
                <div class="text-[10px] text-slate-500 truncate font-semibold uppercase">${t.titolo || 'Senza Titolo'}</div>
            `;
            sidebar.appendChild(sRow);

            // Gantt Row & Bar
            const gRow = document.createElement('div');
            gRow.className = "gantt-row";
            gRow.style.width = `${(totalDays+1)*DAY_PX}px`;

            const startIdx = Math.floor((start - minDate)/(1000*60*60*24));
            const duration = Math.max(1, Math.ceil((end - start)/(1000*60*60*24)));
            
            let color = "linear-gradient(90deg, #007aff, #5856d6)"; // Blue
            if(t.stato === "Completato") color = "linear-gradient(90deg, #34c759, #28cd41)"; // Green
            if(ritardo > 0) color = "linear-gradient(90deg, #ff3b30, #ff9500)"; // Red-Orange Alert

            gRow.innerHTML = `
                <div class="bar" style="left:${startIdx * DAY_PX}px; width:${(duration+1) * DAY_PX}px; background:${color}">
                    ${t.stato}
                </div>
            `;
            body.appendChild(gRow);
        });

        // 5. Linea Oggi
        const todayPos = Math.floor((new Date() - minDate)/(1000*60*60*24)) * DAY_PX;
        const tLine = document.createElement('div');
        tLine.className = "today-line";
        tLine.style.left = `${todayPos}px`;
        body.appendChild(tLine);

        // Scroll automatico a oggi
        const vp = document.getElementById('ganttViewport');
        setTimeout(() => vp.scrollLeft = todayPos - 400, 500);
    }

    // Drag to scroll
    const slider = document.getElementById('ganttViewport');
    let isDown = false; let startX; let scrollLeft;
    slider.addEventListener('mousedown', (e) => { isDown = true; startX = e.pageX - slider.offsetLeft; scrollLeft = slider.scrollLeft; });
    slider.addEventListener('mouseleave', () => isDown = false);
    slider.addEventListener('mouseup', () => isDown = false);
    slider.addEventListener('mousemove', (e) => { if(!isDown) return; e.preventDefault(); const x = e.pageX - slider.offsetLeft; const walk = (x - startX) * 2; slider.scrollLeft = scrollLeft - walk; });

    loadData();
</script>

</body>
</html>
