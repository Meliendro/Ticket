<!DOCTYPE html>
<html lang="it">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Ticket Gantt 2026</title>

<script src="https://cdn.tailwindcss.com"></script>
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
<script src="https://cdn.jsdelivr.net/npm/chartjs-adapter-date-fns"></script>

<style>
body {
    font-family: 'Segoe UI', sans-serif;
    background: linear-gradient(135deg,#0f172a,#1e293b);
}
.card {
    background: rgba(255,255,255,0.95);
    backdrop-filter: blur(10px);
}
</style>
</head>

<body class="p-6">

<div class="card rounded-2xl shadow-2xl p-6 max-w-7xl mx-auto">

<div class="flex justify-between items-center mb-6">
    <h1 class="text-2xl font-bold text-slate-800">ðŸ“Š Gantt Ticket 2026</h1>
    <button onclick="loadData()" class="bg-blue-600 text-white px-4 py-2 rounded hover:bg-blue-700 transition">
        ðŸ”„ Aggiorna
    </button>
</div>

<canvas id="ganttChart" height="120"></canvas>

</div>

<script>
let config = JSON.parse(localStorage.getItem('gh_ticket_config'));
let tickets = [];
let chart;

/* ðŸ”¥ FUNZIONE CONVERSIONE DATE */
function parseDate(value) {
    if(!value) return null;

    // formato DD/MM/YYYY
    if(value.includes("/")){
        const parts = value.split("/");
        return new Date(parts[2], parts[1]-1, parts[0]);
    }

    // formato YYYY-MM-DD
    return new Date(value);
}

async function loadData() {

    if(!config){
        alert("Configurare GitHub prima.");
        return;
    }

    const res = await fetch(`https://api.github.com/repos/${config.repo}/contents/ticket/2026/ticket2026.json`, {
        headers: { Authorization: `token ${config.token}` }
    });

    const data = await res.json();
    tickets = JSON.parse(atob(data.content));

    renderChart();
}

function renderChart(){

    const oggi = new Date();
    oggi.setHours(0,0,0,0);

    const dataset = [];

    tickets
    .sort((a,b)=>a.nrTicket - b.nrTicket)
    .forEach(t=>{

        if(!t.dataInizioPrevista || !t.dataFinePrevista) return;

        const start = parseDate(t.dataInizioPrevista);
        const end = parseDate(t.dataFinePrevista);

        if(!start || !end) return;

        let color = "#3b82f6";

        if(t.dataCompletamentoSviluppo){
            color = "#10b981";
        } else if(end < oggi){
            color = "#ef4444";
        }

        dataset.push({
            x: [start, end],
            y: "Ticket #" + t.nrTicket,
            backgroundColor: color
        });
    });

    if(chart) chart.destroy();

    chart = new Chart(
        document.getElementById('ganttChart'),
        {
            type: 'bar',
            data: {
                datasets: [{
                    data: dataset,
                    borderSkipped: false,
                    borderRadius: 6
                }]
            },
            options: {
                indexAxis: 'y',
                responsive: true,
                plugins: { legend: { display: false }},
                scales: {
                    x: {
                        type: 'time',
                        time: { unit: 'week' }
                    }
                }
            }
        }
    );
}

loadData();
</script>

</body>
</html>
