<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Inserimento Ticket</title>
<script src="https://cdn.tailwindcss.com"></script>
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
</head>
<body class="bg-gray-100 p-4">
<h1 class="text-xl font-bold mb-4">Inserimento / Modifica Ticket</h1>

<form id="ticketForm" class="bg-white p-4 shadow rounded space-y-4">

    <div class="grid grid-cols-2 gap-4">
        <label>Stato
            <select id="stato" class="border p-2 w-full">
                <option value="">-- Seleziona --</option>
                <option>Segnalato</option>
                <option>Preso in carico</option>
                <option>Rilasciato</option>
                <option>in Test</option>
                <option>Completato</option>
            </select>
        </label>
        <label>Tipo
            <select id="tipo" class="border p-2 w-full">
                <option>Bug</option>
                <option>Miglioria</option>
                <option>Nuova richiesta</option>
            </select>
        </label>
    </div>

    <div class="grid grid-cols-2 gap-4">
        <label>Priorit√†
            <select id="priorita" class="border p-2 w-full">
                <option>Alta</option>
                <option>Media</option>
                <option>Bassa</option>
            </select>
        </label>
        <label>Menu
            <select id="menu" class="border p-2 w-full">
                <option>Pianificazione cantieri</option>
                <option>Pianificazione Squadre</option>
                <option>Da segnalare</option>
            </select>
        </label>
    </div>

    <label>Titolo<input id="titolo" class="border p-2 w-full"></label>
    <label>Descrizione<textarea id="descrizione" class="border p-2 w-full"></textarea></label>

    <div class="grid grid-cols-2 gap-4">
        <label>Inserito Da<input id="inseritoDa" class="border p-2 w-full"></label>
        <label>In Carico A<input id="inCaricoA" class="border p-2 w-full"></label>
    </div>

    <div class="grid grid-cols-3 gap-4">
        <label>Data Inizio Prevista<input type="date" id="dataInizioPrevista" class="border p-2 w-full"></label>
        <label>Data Fine Prevista<input type="date" id="dataFinePrevista" class="border p-2 w-full"></label>
        <label>Data Rilascio<input type="date" id="dataRilascio" class="border p-2 w-full"></label>
    </div>

    <label>Descrizione Soluzione<textarea id="descrizioneSoluzione" class="border p-2 w-full"></textarea></label>

    <div class="flex justify-end gap-4">
        <button type="button" onclick="saveTicket()" class="bg-green-600 text-white px-4 py-2 rounded flex items-center gap-2">
            <i class="fas fa-save"></i> Salva
        </button>
        <button type="button" onclick="window.close()" class="bg-gray-400 text-white px-4 py-2 rounded">Chiudi</button>
    </div>
</form>

<script>
let tickets = JSON.parse(localStorage.getItem("tickets") || "[]");
let ticketIndex = window.ticketDataIndex ?? null;
let ticketData = window.ticketData ?? null;

const form = document.getElementById("ticketForm");

function initForm(){
    if(ticketData){
        document.getElementById("stato").value = ticketData.stato;
        document.getElementById("tipo").value = ticketData.tipo;
        document.getElementById("priorita").value = ticketData.priorita;
        document.getElementById("menu").value = ticketData.menu;
        document.getElementById("titolo").value = ticketData.titolo;
        document.getElementById("descrizione").value = ticketData.descrizione;
        document.getElementById("inseritoDa").value = ticketData.inseritoDa;
        document.getElementById("inCaricoA").value = ticketData.inCaricoA;
        document.getElementById("dataInizioPrevista").value = ticketData.dataInizioPrevista;
        document.getElementById("dataFinePrevista").value = ticketData.dataFinePrevista;
        document.getElementById("dataRilascio").value = ticketData.dataRilascio;
        document.getElementById("descrizioneSoluzione").value = ticketData.descrizioneSoluzione;
    }
}

function saveTicket(){
    const now = new Date().toISOString().split("T")[0];
    let ticket = {
        nrTicket: ticketData?.nrTicket ?? tickets.length+1,
        stato: document.getElementById("stato").value,
        tipo: document.getElementById("tipo").value,
        priorita: document.getElementById("priorita").value,
        menu: document.getElementById("menu").value,
        titolo: document.getElementById("titolo").value,
        descrizione: document.getElementById("descrizione").value,
        dataInserimento: ticketData?.dataInserimento ?? now,
        inseritoDa: document.getElementById("inseritoDa").value,
        inCaricoA: document.getElementById("inCaricoA").value,
        dataInizioPrevista: document.getElementById("dataInizioPrevista").value,
        dataFinePrevista: document.getElementById("dataFinePrevista").value,
        dataRilascio: document.getElementById("dataRilascio").value,
        descrizioneSoluzione: document.getElementById("descrizioneSoluzione").value,
        dataSegnalato: ticketData?.dataSegnalato,
        dataPresoInCarico: ticketData?.dataPresoInCarico,
        dataInTest: ticketData?.dataInTest,
        dataCompletato: ticketData?.dataCompletato
    };

    // valorizzazione date stato solo se vuote
    if(ticket.stato==="Segnalato" && !ticket.dataSegnalato) ticket.dataSegnalato=now;
    if(ticket.stato==="Preso in carico" && !ticket.dataPresoInCarico) ticket.dataPresoInCarico=now;
    if(ticket.stato==="in Test" && !ticket.dataInTest) ticket.dataInTest=now;
    if(ticket.stato==="Completato" && !ticket.dataCompletato) ticket.dataCompletato=now;

    if(ticketIndex!==null){
        tickets[ticketIndex]=ticket;
        alert("Ticket aggiornato con successo!");
    } else {
        tickets.push(ticket);
        alert("Ticket creato con successo!");
    }

    localStorage.setItem("tickets", JSON.stringify(tickets));
    window.opener.location.reload();
    window.close();
}

initForm();
</script>
</body>
</html>
