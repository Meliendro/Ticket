<!DOCTYPE html>
<html lang="it">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Ticket Form - RIVIT</title>
<script src="https://cdn.tailwindcss.com"></script>
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
<style>
body {
    font-family: 'Segoe UI', sans-serif;
    background: linear-gradient(135deg,#1e293b,#0f172a);
    min-height: 100vh;
}
.form-card{
    background: rgba(255,255,255,0.95);
    backdrop-filter: blur(10px);
}
input, select, textarea {
    width: 100%;
    padding: 0.6rem;
    border: 1px solid #d1d5db;
    border-radius: 0.6rem;
    transition: all 0.2s ease;
}
input:focus, select:focus, textarea:focus{
    border-color:#2563eb;
    box-shadow:0 0 0 2px rgba(37,99,235,0.2);
    outline:none;
}
input:disabled, select:disabled, textarea:disabled {
    background: #e5e7eb;
}
label {
    font-size: 0.70rem;
    font-weight: 700;
    margin-top: 0.25rem;
    display:block;
    text-transform: uppercase;
    letter-spacing: 0.5px;
    color:#374151;
}
button { cursor: pointer; }
.ticket-number-badge{
    background:#2563eb;
    color:white;
    padding:6px 14px;
    border-radius:999px;
    font-weight:700;
    font-size:0.9rem;
}
.section-title{
    font-size:0.8rem;
    font-weight:800;
    letter-spacing:1px;
    color:#1f2937;
    border-bottom:2px solid #e5e7eb;
    padding-bottom:4px;
    margin-bottom:10px;
}
</style>
</head>
<body class="p-6 flex justify-center">

<div class="form-card w-full max-w-6xl rounded-2xl shadow-2xl p-8">

    <div class="flex justify-between items-center mb-6">
        <h1 id="ticketTitle" class="text-2xl font-extrabold text-gray-800">Nuovo Ticket</h1>
        <div class="ticket-number-badge">
            # <span id="ticketNumberPreview">--</span>
        </div>
    </div>

    <form id="ticketForm" class="space-y-6">
        <div>
            <div class="section-title">INFORMAZIONI GENERALI</div>
            <div class="grid grid-cols-1 md:grid-cols-3 gap-4">
                <div>
                    <label>Nr Ticket</label>
                    <input type="text" id="nrTicket" disabled>
                </div>
                <div>
                    <label>Stato</label>
                    <select id="stato">
                        <option value="">Caricamento...</option>
                    </select>
                </div>
                <div>
                    <label>Tipo</label>
                    <select id="tipo">
                        <option value="">Caricamento...</option>
                    </select>
                </div>
                <div>
                    <label>Bloccante</label>
                    <select id="bloccante">
                        <option value="">Caricamento...</option>
                    </select>
                </div>
                <div>
                    <label>Priorità</label>
                    <select id="priorita">
                        <option value="">Caricamento...</option>
                    </select>
                </div>
                <div>
                    <label>Data Inserimento</label>
                    <input type="date" id="dataInserimento" disabled>
                </div>
            </div>
        </div>

        <div>
            <div class="section-title">DETTAGLIO TICKET</div>
            <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                <div>
                    <label>Ambito</label>
                    <select id="ambito">
                        <option>FASE1</option>
                        <option>FASE2</option>
                        <option>FASE3</option>
                    </select>
                </div>
                <div>
                    <label>Menu</label>
                    <select id="menu">
                        <option value="">Caricamento...</option>
                    </select>
                </div>
                <div>
                    <label>Titolo</label>
                    <input type="text" id="titolo" placeholder="Titolo sintetico">
                </div>
                <div>
                    <label>Descrizione</label>
                    <textarea id="descrizione" rows="3" placeholder="Dettagli del ticket..."></textarea>
                </div>
                <div>
                    <label>Inserito da</label>
                    <input type="text" id="inseritoDa">
                </div>
                <div>
                    <label>In carico a</label>
                    <input type="text" id="inCaricoA">
                </div>
                <div>
                    <label>Data Inizio Prevista</label>
                    <input type="date" id="dataInizioPrevista">
                </div>
                <div>
                    <label>Data Fine Prevista</label>
                    <input type="date" id="dataFinePrevista">
                </div>
                <div>
                    <label>Data Rilascio</label>
                    <input type="date" id="dataRilascio">
                </div>
                <div>
                    <label>Descrizione Attività</label>
                    <textarea id="descrAttivita" rows="2"></textarea>
                </div>
            </div>
        </div>

        <div class="flex justify-center gap-4 mt-6">
            <button type="button" onclick="saveTicket()"
                class="bg-gradient-to-r from-green-600 to-emerald-500 
                text-white px-10 py-3 rounded-xl shadow-lg 
                hover:scale-105 transition transform duration-200 font-bold">
                <i class="fas fa-save"></i> Salva Ticket
            </button>
            <button type="button" onclick="window.close()"
                class="bg-gray-400 text-white px-10 py-3 rounded-xl shadow-lg 
                hover:scale-105 transition transform duration-200 font-bold">
                <i class="fas fa-times"></i> Annulla
            </button>
        </div>
    </form>
</div>

<script>
let config = JSON.parse(localStorage.getItem('gh_ticket_config'));
let editTicketData = JSON.parse(localStorage.getItem('edit_ticket')) || {};

function b64DecodeUnicode(str) {
    return decodeURIComponent(atob(str).split('').map(function(c) {
        return '%' + ('00' + c.charCodeAt(0).toString(16)).slice(-2);
    }).join(''));
}

// Funzione universale per popolare una select
function populateSelect(id, dataArray, placeholder, currentValue) {
    const sel = document.getElementById(id);
    if(!sel) return;
    sel.innerHTML = `<option value="">-- ${placeholder} --</option>`;
    if(dataArray && Array.isArray(dataArray)) {
        dataArray.forEach(item => {
            const opt = document.createElement('option');
            opt.value = item;
            opt.textContent = item;
            if(item === currentValue) opt.selected = true;
            sel.appendChild(opt);
        });
    }
}

async function loadAllOptions() {
    if(!config) return;
    try {
        const url = `https://api.github.com/repos/${config.repo}/contents/ticket/2026/liste.json`;
        const res = await fetch(url, {
            headers: { 'Authorization': `token ${config.token}`, 'Cache-Control': 'no-cache' }
        });
        
        if(!res.ok) throw new Error("File liste.json non trovato in ticket/2026/");
        
        const data = await res.json();
        const lists = JSON.parse(b64DecodeUnicode(data.content));
        
        // Popolamento dinamico usando le chiavi ESATTE del tuo JSON
        populateSelect('stato', lists.Stato, "Seleziona Stato", editTicketData.stato);
        populateSelect('bloccante', lists.Bloccante, "Seleziona Bloccante", editTicketData.bloccante);
        populateSelect('priorita', lists.Priorita, "Seleziona Priorità", editTicketData.priorita);
        populateSelect('tipo', lists.Tipo, "Seleziona Tipo", editTicketData.tipo);
        populateSelect('menu', lists.Menu, "Seleziona Menu", editTicketData.menu);

    } catch(e) {
        console.error(e);
        alert("Errore caricamento liste: " + e.message);
    }
}

function initializeForm() {
    const today = new Date().toISOString().substr(0,10);
    document.getElementById('dataInserimento').value = today;

    if(editTicketData && editTicketData.nrTicket){
        document.getElementById('ticketTitle').innerText = "Modifica Ticket";
        document.getElementById('ticketNumberPreview').innerText = editTicketData.nrTicket;
        
        // Carica dati testuali
        const fields = ['nrTicket', 'titolo', 'descrizione', 'inseritoDa', 'inCaricoA', 
                       'dataInizioPrevista', 'dataFinePrevista', 'dataRilascio', 'descrAttivita', 'ambito'];
        fields.forEach(f => {
            const el = document.getElementById(f);
            if(el && editTicketData[f]) el.value = editTicketData[f];
        });
    }
    
    // Carica le opzioni dai menu a tendina
    loadAllOptions();
}

document.getElementById('stato').addEventListener('change', function(){
    const stato = this.value;
    const now = new Date().toLocaleDateString('it-IT');
    if(stato === "Segnalato" && !editTicketData.dataSegnalato) editTicketData.dataSegnalato = now;
    if(stato === "Preso in carico" && !editTicketData.dataPresoInCarico) editTicketData.dataPresoInCarico = now;
    if(stato === "Rilasciato" && !editTicketData.dataRilasciato) editTicketData.dataRilasciato = now;
    if(stato === "In Test" && !editTicketData.dataInTest) editTicketData.dataInTest = now;
    if(stato === "Completato" && !editTicketData.dataCompletato) editTicketData.dataCompletato = now;
});

async function saveTicket(){
    if(!config){ alert("⚠️ Configura GitHub"); return; }
    const saveBtn = document.querySelector('button[onclick="saveTicket()"]');
    saveBtn.disabled = true;
    saveBtn.innerText = "Salvataggio...";

    try {
        const res = await fetch(`https://api.github.com/repos/${config.repo}/contents/ticket/2026/ticket2026.json`, {
            headers: {Authorization:`token ${config.token}`, 'Cache-Control': 'no-cache'}
        });
        
        let tickets = [];
        let currentSha = "";
        
        if(res.ok) {
            const data = await res.json();
            currentSha = data.sha;
            tickets = JSON.parse(b64DecodeUnicode(data.content));
        }

        let nrTicket = editTicketData.nrTicket || (tickets.length ? Math.max(...tickets.map(t=>t.nrTicket)) + 1 : 1);

        const t = {
            nrTicket,
            stato: document.getElementById('stato').value,
            tipo: document.getElementById('tipo').value,
            bloccante: document.getElementById('bloccante').value,
            priorita: document.getElementById('priorita').value,
            dataInserimento: document.getElementById('dataInserimento').value,
            ambito: document.getElementById('ambito').value,
            menu: document.getElementById('menu').value,
            titolo: document.getElementById('titolo').value,
            descrizione: document.getElementById('descrizione').value,
            inseritoDa: document.getElementById('inseritoDa').value,
            inCaricoA: document.getElementById('inCaricoA').value,
            dataInizioPrevista: document.getElementById('dataInizioPrevista').value,
            dataFinePrevista: document.getElementById('dataFinePrevista').value,
            dataRilascio: document.getElementById('dataRilascio').value,
            descrAttivita: document.getElementById('descrAttivita').value,
            dataSegnalato: editTicketData.dataSegnalato || "",
            dataPresoInCarico: editTicketData.dataPresoInCarico || "",
            dataRilasciato: editTicketData.dataRilasciato || "",
            dataInTest: editTicketData.dataInTest || "",
            dataCompletato: editTicketData.dataCompletato || ""
        };

        if(editTicketData.nrTicket){
            const index = tickets.findIndex(tt => tt.nrTicket === editTicketData.nrTicket);
            if(index !== -1) tickets[index] = t;
            else tickets.push(t);
        } else {
            tickets.push(t);
        }

        const content = btoa(unescape(encodeURIComponent(JSON.stringify(tickets, null, 2))));
        const body = { message: `Ticket #${t.nrTicket}`, content: content, sha: currentSha };

        const putRes = await fetch(`https://api.github.com/repos/${config.repo}/contents/ticket/2026/ticket2026.json`, {
            method: "PUT",
            headers: { "Authorization": `token ${config.token}`, "Content-Type": "application/json" },
            body: JSON.stringify(body)
        });

        if(!putRes.ok) throw new Error("Errore durante l'invio");
        
        alert("Salvataggio completato!");
        window.close();
        
    } catch(e){ 
        alert("Errore: " + e.message); 
        saveBtn.disabled = false;
        saveBtn.innerText = "Salva Ticket";
    }
}

initializeForm();
</script>
</body>
</html>
