<!DOCTYPE html>
<html lang="it">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Ticket Form</title>
<script src="https://cdn.tailwindcss.com"></script>
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
<style>
    body { font-family: 'Segoe UI', sans-serif; background: linear-gradient(135deg,#1e293b,#0f172a); min-height: 100vh; }
    .form-card { background: rgba(255,255,255,0.95); backdrop-filter: blur(10px); }
    input, select, textarea { width: 100%; padding: 0.6rem; border: 1px solid #d1d5db; border-radius: 0.6rem; transition: all 0.2s ease; font-size: 0.9rem; }
    input:focus, select:focus, textarea:focus { border-color:#2563eb; box-shadow:0 0 0 2px rgba(37,99,235,0.2); outline:none; }
    input:disabled { background: #e5e7eb; color: #6b7280; }
    label { font-size: 0.70rem; font-weight: 700; margin-top: 0.25rem; display:block; text-transform: uppercase; color:#374151; letter-spacing: 0.5px; }
    .ticket-number-badge { background:#2563eb; color:white; padding:6px 14px; border-radius:999px; font-weight:700; }
    .section-title { font-size:0.8rem; font-weight:800; color:#1f2937; border-bottom:2px solid #e5e7eb; padding-bottom:4px; margin-bottom:10px; margin-top: 10px; }
</style>
</head>
<body class="p-6 flex justify-center">

<div class="form-card w-full max-w-6xl rounded-2xl shadow-2xl p-8">
    <div class="flex justify-between items-center mb-6">
        <h1 id="ticketTitle" class="text-2xl font-extrabold text-gray-800">Nuovo Ticket</h1>
        <div class="ticket-number-badge"># <span id="ticketNumberPreview">--</span></div>
    </div>

    <form id="ticketForm" class="space-y-6">
        <div>
            <div class="section-title">INFORMAZIONI GENERALI</div>
            <div class="grid grid-cols-1 md:grid-cols-3 gap-4">
                <div><label>Nr Ticket</label><input type="text" id="nrTicket" disabled></div>
                <div><label>Stato</label><select id="stato"><option value="">In attesa...</option></select></div>
                <div><label>Tipo</label><select id="tipo"><option value="">In attesa...</option></select></div>
                <div><label>Bloccante</label><select id="bloccante"><option value="">In attesa...</option></select></div>
                <div><label>Priorità</label><select id="priorita"><option value="">In attesa...</option></select></div>
                <div><label>Data Inserimento</label><input type="date" id="dataInserimento" disabled></div>
            </div>
        </div>

        <div>
            <div class="section-title">DETTAGLIO TICKET</div>
            <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                <div><label>Ambito</label><select id="ambito"><option>FASE1</option><option>FASE2</option><option>FASE3</option></select></div>
                <div><label>Menu</label><select id="menu"><option value="">In attesa...</option></select></div>
                <div><label>Titolo</label><input type="text" id="titolo"></div>
                <div><label>Descrizione</label><textarea id="descrizione" rows="4"></textarea></div>
                <div><label>Inserito da</label><input type="text" id="inseritoDa"></div>
                <div><label>In carico a</label><input type="text" id="inCaricoA"></div>
                <div><label>Data Inizio Prevista</label><input type="date" id="dataInizioPrevista"></div>
                <div><label>Data Fine Prevista</label><input type="date" id="dataFinePrevista"></div>
                <div><label>Data Rilascio</label><input type="date" id="dataRilascio"></div>
                <div><label>Descrizione Attività</label><textarea id="descrAttivita" rows="3"></textarea></div>
            </div>
        </div>

        <div class="flex justify-center gap-4 mt-6">
            <button type="button" id="btnSave" onclick="saveTicket()" class="bg-gradient-to-r from-green-600 to-emerald-500 text-white px-10 py-3 rounded-xl shadow-lg hover:scale-105 transition font-bold">
                <i class="fas fa-save"></i> Salva Ticket
            </button>
            <button type="button" onclick="window.close()" class="bg-gray-400 text-white px-10 py-3 rounded-xl shadow-lg hover:scale-105 transition font-bold">
                <i class="fas fa-times"></i> Annulla
            </button>
        </div>
    </form>
</div>

<script>
// Recupero configurazione (deve essere identica a ticket_table.html)
const config = JSON.parse(localStorage.getItem('gh_ticket_config'));
const editTicketData = JSON.parse(localStorage.getItem('edit_ticket')) || {};

function decodeUTF8(s) {
    try { return decodeURIComponent(escape(atob(s))); } catch (e) { return "Errore"; }
}

function encodeUTF8(s) {
    return btoa(unescape(encodeURIComponent(s)));
}

function populateSelect(id, dataArray, placeholder, currentValue) {
    const sel = document.getElementById(id);
    if(!sel) return;
    sel.innerHTML = `<option value="">-- ${placeholder} --</option>`;
    if(dataArray && Array.isArray(dataArray)) {
        dataArray.forEach(item => {
            const opt = document.createElement('option');
            opt.value = item;
            opt.textContent = item;
            if(item === currentValue) opt.selected = true;
            sel.appendChild(opt);
        });
    }
}

async function loadData() {
    // 1. Controllo immediato configurazione
    if(!config || !config.repo || !config.token) {
        alert("ATTENZIONE: Nessuna configurazione GitHub trovata nel browser.\nTorna alla tabella e usa l'icona ingranaggio.");
        return;
    }

    try {
        // PERCORSO FILE JSON (Assicurati che su GitHub sia esattamente così)
        const path = `https://api.github.com/repos/${config.repo}/contents/ticket/2026/liste.json`;
        
        const res = await fetch(path, {
            headers: { 
                'Authorization': `token ${config.token}`,
                'Cache-Control': 'no-cache' 
            }
        });
        
        if(!res.ok) {
            throw new Error(`GitHub non trova il file delle liste (Status: ${res.status}). Controlla il percorso: /ticket/2026/liste.json`);
        }
        
        const data = await res.json();
        const content = decodeUTF8(data.content);
        const lists = JSON.parse(content);

        // Popolamento select (Uso le chiavi Maiuscole come da tuo standard)
        populateSelect('stato', lists.Stato, "Seleziona Stato", editTicketData.stato);
        populateSelect('tipo', lists.Tipo, "Seleziona Tipo", editTicketData.tipo);
        populateSelect('bloccante', lists.Bloccante, "Seleziona Bloccante", editTicketData.bloccante);
        populateSelect('priorita', lists.Priorita, "Seleziona Priorità", editTicketData.priorita);
        populateSelect('menu', lists.Menu, "Seleziona Menu", editTicketData.menu);

        // Impostazione data e campi esistenti
        document.getElementById('dataInserimento').value = editTicketData.dataInserimento || new Date().toISOString().substr(0,10);

        if(editTicketData.nrTicket) {
            document.getElementById('ticketTitle').innerText = "Modifica Ticket";
            document.getElementById('ticketNumberPreview').innerText = editTicketData.nrTicket;
            
            const fields = ['nrTicket', 'titolo', 'descrizione', 'inseritoDa', 'inCaricoA', 
                          'dataInizioPrevista', 'dataFinePrevista', 'dataRilascio', 'descrAttivita', 'ambito'];
            fields.forEach(f => {
                let el = document.getElementById(f);
                if(el && editTicketData[f]) el.value = editTicketData[f];
            });
        }
    } catch(e) {
        console.error("Dettaglio errore fetch:", e);
        alert("Errore caricamento liste:\n" + e.message);
    }
}

async function saveTicket() {
    const btn = document.getElementById('btnSave');
    btn.disabled = true;
    btn.innerHTML = '<i class="fas fa-spinner fa-spin"></i> Salvataggio...';

    try {
        const urlFile = `https://api.github.com/repos/${config.repo}/contents/ticket/2026/ticket2026.json`;
        const res = await fetch(urlFile, {
            headers: { Authorization: `token ${config.token}`, 'Cache-Control': 'no-cache' }
        });
        
        if(!res.ok) throw new Error("File ticket2026.json non trovato su GitHub.");

        const data = await res.json();
        const tickets = JSON.parse(decodeUTF8(data.content));
        const sha = data.sha;

        let nrTicket = editTicketData.nrTicket || (tickets.length ? Math.max(...tickets.map(t=>t.nrTicket)) + 1 : 1);
        
        const t = {
            nrTicket,
            stato: document.getElementById('stato').value,
            tipo: document.getElementById('tipo').value,
            bloccante: document.getElementById('bloccante').value,
            priorita: document.getElementById('priorita').value,
            dataInserimento: document.getElementById('dataInserimento').value,
            ambito: document.getElementById('ambito').value,
            menu: document.getElementById('menu').value,
            titolo: document.getElementById('titolo').value,
            descrizione: document.getElementById('descrizione').value,
            inseritoDa: document.getElementById('inseritoDa').value,
            inCaricoA: document.getElementById('inCaricoA').value,
            dataInizioPrevista: document.getElementById('dataInizioPrevista').value,
            dataFinePrevista: document.getElementById('dataFinePrevista').value,
            dataRilascio: document.getElementById('dataRilascio').value,
            descrAttivita: document.getElementById('descrAttivita').value,
            dataSegnalato: editTicketData.dataSegnalato || "",
            dataPresoInCarico: editTicketData.dataPresoInCarico || "",
            dataRilasciato: editTicketData.dataRilasciato || "",
            dataInTest: editTicketData.dataInTest || "",
            dataCompletato: editTicketData.dataCompletato || ""
        };

        const now = new Date().toLocaleDateString('it-IT');
        if(t.stato === "Segnalato" && !t.dataSegnalato) t.dataSegnalato = now;
        if(t.stato === "Preso in carico" && !t.dataPresoInCarico) t.dataPresoInCarico = now;
        if(t.stato === "Rilasciato" && !t.dataRilasciato) t.dataRilasciato = now;
        if(t.stato === "In Test" && !t.dataInTest) t.dataInTest = now;
        if(t.stato === "Completato" && !t.dataCompletato) t.dataCompletato = now;

        const index = tickets.findIndex(tt => tt.nrTicket === nrTicket);
        if(index !== -1) tickets[index] = t; else tickets.push(t);

        const content = encodeUTF8(JSON.stringify(tickets, null, 2));
        const putRes = await fetch(urlFile, {
            method: "PUT",
            headers: { Authorization: `token ${config.token}`, "Content-Type": "application/json" },
            body: JSON.stringify({ message: `Update Ticket #${nrTicket}`, content, sha })
        });

        if(putRes.ok) { 
            alert("Ticket salvato con successo!");
            window.close(); 
        } else {
            throw new Error("Errore durante il salvataggio su GitHub.");
        }
    } catch(e) {
        alert("Errore salvataggio: " + e.message);
        btn.disabled = false;
        btn.innerHTML = '<i class="fas fa-save"></i> Salva Ticket';
    }
}

// Avvio automatico al caricamento
loadData();
</script>
</body>
</html>
