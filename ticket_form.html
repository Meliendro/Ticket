<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Ticket Form</title>
<script src="https://cdn.tailwindcss.com"></script>
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
<style>
body { font-family: 'Segoe UI', sans-serif; background: #f4f4f5; }
h1 { font-weight: 700; text-align: center; margin-bottom: 1rem; }
input, select, textarea { width: 100%; padding: 0.5rem; border: 1px solid #d1d5db; border-radius: 0.5rem; }
input:disabled, select:disabled, textarea:disabled { background: #e5e7eb; }
label { font-size: 0.75rem; font-weight: bold; margin-top: 0.25rem; display:block; }
button { cursor: pointer; }
</style>
</head>
<body class="p-6">

<h1 id="ticketTitle">Nuovo Ticket</h1>

<form id="ticketForm" class="space-y-4">

    <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
        <div>
            <label>Nr Ticket</label>
            <input type="text" id="nrTicket" disabled>
        </div>
        <div>
            <label>Stato</label>
            <select id="stato">
                <option value="">-- Seleziona Stato --</option>
                <option>Segnalato</option>
                <option>Preso in carico</option>
                <option>Rilasciato</option>
                <option>In Test</option>
                <option>Completato</option>
            </select>
        </div>
        <div>
            <label>Tipo</label>
            <select id="tipo">
                <option>Bug</option>
                <option>Miglioria</option>
                <option>Nuova richiesta</option>
            </select>
        </div>
        <div>
            <label>Bloccante</label>
            <select id="bloccante">
                <option>Bloccante</option>
                <option>Non Bloccante</option>
            </select>
        </div>
        <div>
            <label>Priorità</label>
            <select id="priorita">
                <option>Alta</option>
                <option>Media</option>
                <option>Bassa</option>
            </select>
        </div>
        <div>
            <label>Data Inserimento</label>
            <input type="date" id="dataInserimento" disabled>
        </div>
    </div>

    <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
        <div>
            <label>Ambito</label>
            <select id="ambito">
                <option>FASE1</option>
                <option>FASE2</option>
                <option>FASE3</option>
            </select>
        </div>
        <div>
            <label>Menu</label>
            <select id="menu">
                <option>Pianificazione cantieri</option>
                <option>Pianificazione Squadre</option>
                <option>Da segnalare</option>
            </select>
        </div>
        <div>
            <label>Titolo</label>
            <input type="text" id="titolo">
        </div>
        <div>
            <label>Descrizione</label>
            <textarea id="descrizione" rows="3"></textarea>
        </div>
        <div>
            <label>Inserito da</label>
            <input type="text" id="inseritoDa">
        </div>
        <div>
            <label>In carico a</label>
            <input type="text" id="inCaricoA">
        </div>
        <div>
            <label>Data Inizio Prevista</label>
            <input type="date" id="dataInizioPrevista">
        </div>
        <div>
            <label>Data Fine Prevista</label>
            <input type="date" id="dataFinePrevista">
        </div>
        <div>
            <label>Data Rilascio</label>
            <input type="date" id="dataRilascio">
        </div>
        <div>
            <label>Descrizione Attività</label>
            <textarea id="descrAttivita" rows="2"></textarea>
        </div>
    </div>

    <div class="flex justify-center gap-4 mt-4">
        <button type="button" onclick="saveTicket()" class="bg-green-600 text-white px-6 py-2 rounded shadow hover:bg-green-700"><i class="fas fa-save"></i> Salva Ticket</button>
    </div>

</form>

<script>
let config = JSON.parse(localStorage.getItem('gh_ticket_config'));
let tickets = [];
let fileSha = "";
let editTicketData = JSON.parse(localStorage.getItem('edit_ticket'));
const ticketForm = document.getElementById('ticketForm');

function initializeForm() {
    const today = new Date().toISOString().substr(0,10);
    document.getElementById('dataInserimento').value = today;

    if(editTicketData){
        document.getElementById('ticketTitle').innerText = "Modifica Ticket #" + editTicketData.nrTicket;
        for(const key in editTicketData){
            if(document.getElementById(key)) document.getElementById(key).value = editTicketData[key];
        }
        localStorage.removeItem('edit_ticket');
    }
}

document.getElementById('stato').addEventListener('change', function(){
    const stato = this.value;
    const now = new Date().toLocaleDateString();
    switch(stato){
        case "Segnalato": if(!editTicketData?.dataSegnalato) editTicketData.dataSegnalato = now; break;
        case "Preso in carico": if(!editTicketData?.dataPresoInCarico) editTicketData.dataPresoInCarico = now; break;
        case "Rilasciato": if(!editTicketData?.dataRilasciato) editTicketData.dataRilasciato = now; break;
        case "In Test": if(!editTicketData?.dataInTest) editTicketData.dataInTest = now; break;
        case "Completato": if(!editTicketData?.dataCompletato) editTicketData.dataCompletato = now; break;
    }
});

async function saveTicket(){
    if(!config){ alert("⚠️ Configura GitHub prima di salvare"); return; }
    try {
        const res = await fetch(`https://api.github.com/repos/${config.repo}/contents/ticket/2026/ticket2026.json`, {
            headers: {Authorization:`token ${config.token}`}
        });
        const data = await res.json();
        tickets = JSON.parse(atob(data.content));
        fileSha = data.sha;

        let nrTicket = editTicketData?.nrTicket || (tickets.length ? tickets[tickets.length-1].nrTicket+1 : 1);

        const t = {
            nrTicket,
            stato: document.getElementById('stato').value,
            tipo: document.getElementById('tipo').value,
            bloccante: document.getElementById('bloccante').value,
            priorita: document.getElementById('priorita').value,
            dataInserimento: document.getElementById('dataInserimento').value,
            ambito: document.getElementById('ambito').value,
            menu: document.getElementById('menu').value,
            titolo: document.getElementById('titolo').value,
            descrizione: document.getElementById('descrizione').value,
            inseritoDa: document.getElementById('inseritoDa').value,
            inCaricoA: document.getElementById('inCaricoA').value,
            dataInizioPrevista: document.getElementById('dataInizioPrevista').value,
            dataFinePrevista: document.getElementById('dataFinePrevista').value,
            dataRilascio: document.getElementById('dataRilascio').value,
            descrAttivita: document.getElementById('descrAttivita').value,
            dataSegnalato: editTicketData?.dataSegnalato || "",
            dataPresoInCarico: editTicketData?.dataPresoInCarico || "",
            dataRilasciato: editTicketData?.dataRilasciato || "",
            dataInTest: editTicketData?.dataInTest || "",
            dataCompletato: editTicketData?.dataCompletato || ""
        };

        if(editTicketData){
            const index = tickets.findIndex(tt=>tt.nrTicket===editTicketData.nrTicket);
            tickets[index] = t;
        } else tickets.push(t);

        const content = btoa(unescape(encodeURIComponent(JSON.stringify(tickets,null,2))));
        const body = {message:`Ticket #${t.nrTicket}`, content, sha:fileSha};
        const putRes = await fetch(`https://api.github.com/repos/${config.repo}/contents/ticket/2026/ticket2026.json`, {
            method:"PUT",
            headers: {"Authorization":`token ${config.token}`, "Content-Type":"application/json"},
            body: JSON.stringify(body)
        });
        if(!putRes.ok) throw new Error("Errore salvataggio");
        alert("Ticket salvato con successo!");
        window.close();
    } catch(e){ alert("Errore: "+e.message); }
}

initializeForm();
</script>
</body>
</html>
