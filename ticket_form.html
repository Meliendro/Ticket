<!DOCTYPE html>
<html lang="it">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Ticket Form</title>

<script src="https://cdn.tailwindcss.com"></script>
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">

<style>
body { font-family: 'Segoe UI', sans-serif; background: #f3f4f6; }
.card { background:white; }
</style>
</head>

<body class="p-6">

<div class="max-w-4xl mx-auto card rounded-xl shadow-xl p-6">

<h1 class="text-2xl font-bold mb-6 text-slate-800">Gestione Ticket</h1>

<form id="ticketForm" class="grid grid-cols-2 gap-4">

<input type="hidden" id="nrTicket">

<div>
<label class="text-sm font-semibold">Stato</label>
<select id="stato" class="w-full border p-2 rounded"></select>
</div>

<div>
<label class="text-sm font-semibold">Tipo</label>
<select id="tipo" class="w-full border p-2 rounded"></select>
</div>

<div>
<label class="text-sm font-semibold">Bloccante</label>
<select id="bloccante" class="w-full border p-2 rounded"></select>
</div>

<div>
<label class="text-sm font-semibold">PrioritÃ </label>
<select id="priorita" class="w-full border p-2 rounded"></select>
</div>

<div class="col-span-2">
<label class="text-sm font-semibold">Titolo</label>
<input type="text" id="titolo" class="w-full border p-2 rounded">
</div>

<div class="col-span-2">
<label class="text-sm font-semibold">Descrizione</label>
<textarea id="descrizione" rows="4" class="w-full border p-2 rounded"></textarea>
</div>

<div>
<label class="text-sm font-semibold">Ambito</label>
<input type="text" id="ambito" class="w-full border p-2 rounded">
</div>

<div>
<label class="text-sm font-semibold">Menu</label>
<select id="menu" class="w-full border p-2 rounded"></select>
</div>

<div>
<label class="text-sm font-semibold">Inserito da</label>
<select id="inseritoDa" class="w-full border p-2 rounded"></select>
</div>

<div>
<label class="text-sm font-semibold">In carico a</label>
<input type="text" id="inCaricoA" class="w-full border p-2 rounded">
</div>

<div>
<label class="text-sm font-semibold">Data Segnalato</label>
<input type="date" id="dataSegnalato" class="w-full border p-2 rounded">
</div>

<div>
<label class="text-sm font-semibold">Data Inizio Prevista</label>
<input type="date" id="dataInizioPrevista" class="w-full border p-2 rounded">
</div>

<div>
<label class="text-sm font-semibold">Data Fine Prevista</label>
<input type="date" id="dataFinePrevista" class="w-full border p-2 rounded">
</div>

<div>
<label class="text-sm font-semibold">Data Completamento</label>
<input type="date" id="dataCompletamentoSviluppo" class="w-full border p-2 rounded">
</div>

<div class="col-span-2 text-right mt-4">
<button type="button" onclick="saveTicket()" class="bg-blue-600 text-white px-6 py-2 rounded hover:bg-blue-700">
ðŸ’¾ Salva
</button>
</div>

</form>
</div>

<script>

let config = JSON.parse(localStorage.getItem('gh_ticket_config'));
let tickets = [];
let fileSha = "";
let editMode = false;

async function loadListe(){

    if(!config){ alert("Configura GitHub prima."); return; }

    const res = await fetch(
        `https://api.github.com/repos/${config.repo}/contents/liste.json?ref=main`,
        { headers:{ Authorization:`token ${config.token}` }}
    );

    const data = await res.json();
    const liste = JSON.parse(atob(data.content));

    popola("stato", liste.Stato);
    popola("tipo", liste.Tipo);
    popola("bloccante", liste.Bloccante);
    popola("priorita", liste.Priorita);
    popola("menu", liste.Menu);
    popola("inseritoDa", liste.Email);
}

function popola(id, valori){
    const select = document.getElementById(id);
    select.innerHTML = "";
    valori.forEach(v=>{
        const opt=document.createElement("option");
        opt.value=v;
        opt.text=v;
        select.appendChild(opt);
    });
}

async function loadTickets(){

    const res = await fetch(
        `https://api.github.com/repos/${config.repo}/contents/ticket/2026/ticket2026.json?ref=main`,
        { headers:{ Authorization:`token ${config.token}` }}
    );

    const data = await res.json();
    fileSha = data.sha;
    tickets = JSON.parse(atob(data.content));
}

function fillForm(ticket){

    Object.keys(ticket).forEach(k=>{
        const el = document.getElementById(k);
        if(el) el.value = ticket[k] || "";
    });

    editMode = true;
}

async function saveTicket(){

    const ticket = {
        nrTicket: document.getElementById("nrTicket").value,
        stato: stato.value,
        tipo: tipo.value,
        bloccante: bloccante.value,
        priorita: priorita.value,
        titolo: titolo.value,
        descrizione: descrizione.value,
        ambito: ambito.value,
        menu: menu.value,
        inseritoDa: inseritoDa.value,
        inCaricoA: inCaricoA.value,
        dataSegnalato: dataSegnalato.value,
        dataInizioPrevista: dataInizioPrevista.value,
        dataFinePrevista: dataFinePrevista.value,
        dataCompletamentoSviluppo: dataCompletamentoSviluppo.value
    };

    if(!editMode){
        ticket.nrTicket = tickets.length > 0 ? Math.max(...tickets.map(t=>t.nrTicket))+1 : 1;
        tickets.push(ticket);
    } else {
        const index = tickets.findIndex(t=>t.nrTicket == ticket.nrTicket);
        tickets[index] = ticket;
    }

    const content = btoa(JSON.stringify(tickets, null, 2));

    await fetch(
        `https://api.github.com/repos/${config.repo}/contents/ticket/2026/ticket2026.json`,
        {
            method:"PUT",
            headers:{ Authorization:`token ${config.token}` },
            body:JSON.stringify({
                message:"Aggiornamento ticket",
                content:content,
                sha:fileSha,
                branch:"main"
            })
        }
    );

    alert("Salvato con successo!");

    const channel = new BroadcastChannel('ticket_updates');
    channel.postMessage('reload_table');

    window.close();
}

async function init(){
    await loadListe();
    await loadTickets();

    const editTicket = localStorage.getItem('edit_ticket');
    if(editTicket){
        fillForm(JSON.parse(editTicket));
    }
}

init();

</script>
</body>
</html>
