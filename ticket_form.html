<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Ticket Form 2026</title>
<script src="https://cdn.tailwindcss.com"></script>
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
<style>
    body { font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif; background:#f5f5f5; }
    .glass-panel { background: rgba(255,255,255,0.95); backdrop-filter: blur(12px); border-radius:1rem; padding:2rem; max-width:900px; margin:auto; margin-top:20px; }
    label { font-size:0.8rem; font-weight:bold; color:#374151; }
    input, select, textarea { width:100%; padding:0.5rem; border-radius:0.5rem; border:1px solid #d1d5db; margin-bottom:0.7rem; }
    button { padding:0.5rem 1rem; border-radius:0.5rem; cursor:pointer; font-weight:bold; }
    .btn-save { background:#3b82f6; color:white; }
    .btn-cancel { background:#ef4444; color:white; margin-left:0.5rem; }
    .ticket-number { font-size:1.5rem; font-weight:bold; margin-bottom:1rem; color:#1e40af; }
</style>
</head>
<body>

<div class="glass-panel">
    <div id="ticketHeader" class="ticket-number"></div>
    <form id="ticketForm">

        <div class="grid grid-cols-2 gap-4">
            <div>
                <label>STATO</label>
                <select id="stato" required>
                    <option value="">-- Seleziona --</option>
                    <option value="Segnalato">Segnalato</option>
                    <option value="Preso in carico">Preso in carico</option>
                    <option value="In Test">In Test</option>
                    <option value="Rilasciato">Rilasciato</option>
                    <option value="Completato">Completato</option>
                </select>
            </div>

            <div>
                <label>Tipo</label>
                <select id="tipo" required>
                    <option value="Bug">Bug</option>
                    <option value="Miglioria">Miglioria</option>
                    <option value="Nuova richiesta">Nuova richiesta</option>
                </select>
            </div>

            <div>
                <label>Bloccante</label>
                <select id="bloccante" required>
                    <option value="Bloccante">Bloccante</option>
                    <option value="Non Bloccante">Non Bloccante</option>
                </select>
            </div>

            <div>
                <label>Priorità</label>
                <select id="priorita" required>
                    <option value="Alta">Alta</option>
                    <option value="Media">Media</option>
                    <option value="Bassa">Bassa</option>
                </select>
            </div>

            <div>
                <label>Data Inserimento</label>
                <input type="date" id="dataInserimento" required>
            </div>

            <div>
                <label>Ambito</label>
                <select id="ambito">
                    <option value="FASE1">FASE1</option>
                    <option value="FASE2">FASE2</option>
                    <option value="FASE3">FASE3</option>
                </select>
            </div>

            <div>
                <label>Menu</label>
                <select id="menu">
                    <option value="Pianificazione cantieri">Pianificazione cantieri</option>
                    <option value="Pianificazione Squadre">Pianificazione Squadre</option>
                    <option value="Da segnalare">Da segnalare</option>
                </select>
            </div>

            <div>
                <label>Titolo</label>
                <input type="text" id="titolo" required>
            </div>

            <div class="col-span-2">
                <label>Descrizione</label>
                <textarea id="descrizione" rows="3" required></textarea>
            </div>

            <div>
                <label>Inserito da</label>
                <input type="text" id="inseritoDa" required>
            </div>

            <div>
                <label>In carico a</label>
                <input type="text" id="inCaricoA">
            </div>

            <div>
                <label>Data Inizio Prevista</label>
                <input type="date" id="dataInizioPrevista">
            </div>

            <div>
                <label>Data Fine Prevista</label>
                <input type="date" id="dataFinePrevista">
            </div>

            <div>
                <label>Data Rilascio</label>
                <input type="date" id="dataRilascio">
            </div>

            <div class="col-span-2">
                <label>Descrizione Attività Soluzione</label>
                <textarea id="descrizioneAttivitaSoluzione" rows="2"></textarea>
            </div>
        </div>

        <div class="mt-4">
            <button type="submit" class="btn btn-save">Salva Ticket</button>
            <button type="button" class="btn btn-cancel" onclick="window.close()">Annulla</button>
        </div>
    </form>
</div>

<script>
let config = JSON.parse(localStorage.getItem('ticket_config'));
let tickets = [];
let editTicketData = JSON.parse(localStorage.getItem('edit_ticket'));
let fileSha = "";

function loadTickets(){
    if(!config) { alert("⚠️ Configura GitHub"); return; }
    const url = `https://api.github.com/repos/${config.repo}/contents/ticket/2026/ticket2026.json`;
    fetch(url,{headers:{"Authorization":`token ${config.token}`}})
    .then(res=>res.ok?res.json():Promise.reject("Errore caricamento ticket"))
    .then(data=>{
        fileSha = data.sha;
        tickets = JSON.parse(atob(data.content));
        if(editTicketData) prefillForm(editTicketData);
    })
    .catch(e=>alert(e));
}

function prefillForm(t){
    document.getElementById('ticketHeader').innerText = "Ticket Nr: " + t.nrTicket;
    document.getElementById('stato').value = t.stato || "";
    document.getElementById('tipo').value = t.tipo;
    document.getElementById('bloccante').value = t.bloccante;
    document.getElementById('priorita').value = t.priorita;
    document.getElementById('dataInserimento').value = t.dataInserimento;
    document.getElementById('ambito').value = t.ambito;
    document.getElementById('menu').value = t.menu;
    document.getElementById('titolo').value = t.titolo;
    document.getElementById('descrizione').value = t.descrizione;
    document.getElementById('inseritoDa').value = t.inseritoDa;
    document.getElementById('inCaricoA').value = t.inCaricoA;
    document.getElementById('dataInizioPrevista').value = t.dataInizioPrevista;
    document.getElementById('dataFinePrevista').value = t.dataFinePrevista;
    document.getElementById('dataRilascio').value = t.dataRilascio;
    document.getElementById('descrizioneAttivitaSoluzione').value = t.descrizioneAttivitaSoluzione;
}

// Aggiorna la data quando lo stato cambia
document.getElementById('stato').addEventListener('change', function(){
    const now = new Date().toISOString().split('T')[0];
    if(this.value==="Segnalato" && !editTicketData?.dataSegnalato) editTicketData.dataSegnalato = now;
    if(this.value==="Preso in carico" && !editTicketData?.dataPresoInCarico) editTicketData.dataPresoInCarico = now;
    if(this.value==="Rilasciato" && !editTicketData?.dataRilasciato) editTicketData.dataRilasciato = now;
    if(this.value==="In Test" && !editTicketData?.dataInTest) editTicketData.dataInTest = now;
    if(this.value==="Completato" && !editTicketData?.dataCompletato) editTicketData.dataCompletato = now;
});

// Salvataggio
document.getElementById('ticketForm').onsubmit = async function(e){
    e.preventDefault();
    if(!config){ alert("Configurare GitHub"); return; }

    const newTicket = {
        nrTicket: editTicketData?.nrTicket || (tickets.length+1),
        stato: document.getElementById('stato').value,
        tipo: document.getElementById('tipo').value,
        bloccante: document.getElementById('bloccante').value,
        priorita: document.getElementById('priorita').value,
        dataInserimento: document.getElementById('dataInserimento').value,
        ambito: document.getElementById('ambito').value,
        menu: document.getElementById('menu').value,
        titolo: document.getElementById('titolo').value,
        descrizione: document.getElementById('descrizione').value,
        inseritoDa: document.getElementById('inseritoDa').value,
        inCaricoA: document.getElementById('inCaricoA').value,
        dataInizioPrevista: document.getElementById('dataInizioPrevista').value,
        dataFinePrevista: document.getElementById('dataFinePrevista').value,
        dataRilascio: document.getElementById('dataRilascio').value,
        descrizioneAttivitaSoluzione: document.getElementById('descrizioneAttivitaSoluzione').value,
        dataSegnalato: editTicketData?.dataSegnalato || "",
        dataPresoInCarico: editTicketData?.dataPresoInCarico || "",
        dataRilasciato: editTicketData?.dataRilasciato || "",
        dataInTest: editTicketData?.dataInTest || "",
        dataCompletato: editTicketData?.dataCompletato || ""
    };

    if(editTicketData){ // modifica
        const index = tickets.findIndex(t=>t.nrTicket===editTicketData.nrTicket);
        tickets[index] = newTicket;
    } else { // nuovo ticket
        tickets.push(newTicket);
    }

    const content = btoa(unescape(encodeURIComponent(JSON.stringify(tickets,null,2))));
    const url = `https://api.github.com/repos/${config.repo}/contents/ticket/2026/ticket2026.json`;
    const body = {message: `Ticket: ${newTicket.nrTicket}`, content, sha:fileSha};
    
    const res = await fetch(url,{method:"PUT", headers:{"Authorization":`token ${config.token}`,"Content-Type":"application/json"}, body:JSON.stringify(body)});
    if(res.ok){ alert("Ticket salvato!"); window.close(); } 
    else { alert("Errore salvataggio"); }
}

// Precompila data inserimento
if(!editTicketData) document.getElementById('dataInserimento').value = new Date().toISOString().split('T')[0];

window.onload = loadTickets;
</script>

</body>
</html>
