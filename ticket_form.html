<!DOCTYPE html>
<html lang="it">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Ticket Form - RIVIT</title>
<script src="https://cdn.tailwindcss.com"></script>
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
<style>
    body { font-family: 'Segoe UI', sans-serif; background: linear-gradient(135deg,#1e293b,#0f172a); min-height: 100vh; }
    .form-card { background: rgba(255,255,255,0.95); backdrop-filter: blur(10px); }
    input, select, textarea { width: 100%; padding: 0.6rem; border: 1px solid #d1d5db; border-radius: 0.6rem; transition: all 0.2s ease; }
    input:focus, select:focus, textarea:focus { border-color:#2563eb; box-shadow:0 0 0 2px rgba(37,99,235,0.2); outline:none; }
    input:disabled { background: #e5e7eb; }
    label { font-size: 0.70rem; font-weight: 700; margin-top: 0.25rem; display:block; text-transform: uppercase; color:#374151; }
    .ticket-number-badge { background:#2563eb; color:white; padding:6px 14px; border-radius:999px; font-weight:700; }
    .section-title { font-size:0.8rem; font-weight:800; color:#1f2937; border-bottom:2px solid #e5e7eb; padding-bottom:4px; margin-bottom:10px; }
</style>
</head>
<body class="p-6 flex justify-center">

<div class="form-card w-full max-w-6xl rounded-2xl shadow-2xl p-8">
    <div class="flex justify-between items-center mb-6">
        <h1 id="ticketTitle" class="text-2xl font-extrabold text-gray-800">Nuovo Ticket</h1>
        <div class="ticket-number-badge"># <span id="ticketNumberPreview">--</span></div>
    </div>

    <form id="ticketForm" class="space-y-6">
        <div>
            <div class="section-title">INFORMAZIONI GENERALI</div>
            <div class="grid grid-cols-1 md:grid-cols-3 gap-4">
                <div><label>Nr Ticket</label><input type="text" id="nrTicket" disabled></div>
                <div><label>Stato</label><select id="stato"><option value="">Caricamento...</option></select></div>
                <div><label>Tipo</label><select id="tipo"><option value="">Caricamento...</option></select></div>
                <div><label>Bloccante</label><select id="bloccante"><option value="">Caricamento...</option></select></div>
                <div><label>Priorità</label><select id="priorita"><option value="">Caricamento...</option></select></div>
                <div><label>Data Inserimento</label><input type="date" id="dataInserimento" disabled></div>
            </div>
        </div>

        <div>
            <div class="section-title">DETTAGLIO TICKET</div>
            <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                <div><label>Ambito</label><select id="ambito"><option>FASE1</option><option>FASE2</option><option>FASE3</option></select></div>
                <div><label>Menu</label><select id="menu"><option value="">Caricamento...</option></select></div>
                <div><label>Titolo</label><input type="text" id="titolo"></div>
                <div><label>Descrizione</label><textarea id="descrizione" rows="3"></textarea></div>
                <div><label>Inserito da</label><input type="text" id="inseritoDa"></div>
                <div><label>In carico a</label><input type="text" id="inCaricoA"></div>
                <div><label>Data Inizio Prevista</label><input type="date" id="dataInizioPrevista"></div>
                <div><label>Data Fine Prevista</label><input type="date" id="dataFinePrevista"></div>
                <div><label>Data Rilascio</label><input type="date" id="dataRilascio"></div>
                <div><label>Descrizione Attività</label><textarea id="descrAttivita" rows="2"></textarea></div>
            </div>
        </div>

        <div class="flex justify-center gap-4 mt-6">
            <button type="button" onclick="saveTicket()" class="bg-gradient-to-r from-green-600 to-emerald-500 text-white px-10 py-3 rounded-xl shadow-lg hover:scale-105 transition font-bold">
                <i class="fas fa-save"></i> Salva Ticket
            </button>
            <button type="button" onclick="window.close()" class="bg-gray-400 text-white px-10 py-3 rounded-xl shadow-lg hover:scale-105 transition font-bold">
                <i class="fas fa-times"></i> Annulla
            </button>
        </div>
    </form>
</div>

<script>
let config = JSON.parse(localStorage.getItem('gh_ticket_config'));
let editTicketData = JSON.parse(localStorage.getItem('edit_ticket')) || {};

// Decodifica Base64 sicura per UTF-8 (essenziale per caratteri accentati)
function decodeB64(str) {
    return decodeURIComponent(atob(str).split('').map(c => '%' + ('00' + c.charCodeAt(0).toString(16)).slice(-2)).join(''));
}

// Popola le select con i dati dal JSON
function populateSelect(id, dataArray, placeholder, currentValue) {
    const sel = document.getElementById(id);
    if(!sel) return;
    sel.innerHTML = `<option value="">-- ${placeholder} --</option>`;
    if(dataArray) {
        dataArray.forEach(item => {
            const opt = document.createElement('option');
            opt.value = item;
            opt.textContent = item;
            if(item === currentValue) opt.selected = true;
            sel.appendChild(opt);
        });
    }
}

async function loadData() {
    if(!config) { alert("Configurazione GitHub mancante!"); return; }

    try {
        // 1. Carica le liste dinamiche (Stato, Tipo, etc.)
        const resLists = await fetch(`https://api.github.com/repos/${config.repo}/contents/ticket/2026/liste.json`, {
            headers: { Authorization: `token ${config.token}` }
        });
        if(!resLists.ok) throw new Error("Impossibile trovare ticket/2026/liste.json");
        
        const dataLists = await resLists.json();
        const lists = JSON.parse(decodeB64(dataLists.content));

        // Usa le chiavi con la maiuscola come nel tuo JSON
        populateSelect('stato', lists.Stato, "Stato", editTicketData.stato);
        populateSelect('tipo', lists.Tipo, "Tipo", editTicketData.tipo);
        populateSelect('bloccante', lists.Bloccante, "Bloccante", editTicketData.bloccante);
        populateSelect('priorita', lists.Priorita, "Priorità", editTicketData.priorita);
        populateSelect('menu', lists.Menu, "Menu", editTicketData.menu);

        // 2. Inizializza campi data e numero ticket se nuovo
        const today = new Date().toISOString().substr(0,10);
        document.getElementById('dataInserimento').value = editTicketData.dataInserimento || today;

        if(editTicketData.nrTicket) {
            document.getElementById('ticketTitle').innerText = "Modifica Ticket";
            document.getElementById('ticketNumberPreview').innerText = editTicketData.nrTicket;
            for(let key in editTicketData) {
                let el = document.getElementById(key);
                if(el && key !== 'stato' && key !== 'tipo' && key !== 'bloccante' && key !== 'priorita' && key !== 'menu') {
                    el.value = editTicketData[key];
                }
            }
        }
    } catch(e) {
        alert("Errore caricamento dati: " + e.message);
    }
}

async function saveTicket() {
    try {
        const res = await fetch(`https://api.github.com/repos/${config.repo}/contents/ticket/2026/ticket2026.json`, {
            headers: { Authorization: `token ${config.token}` }
        });
        const data = await res.json();
        const tickets = JSON.parse(decodeB64(data.content));
        const sha = data.sha;

        let nrTicket = editTicketData.nrTicket || (tickets.length ? Math.max(...tickets.map(t=>t.nrTicket)) + 1 : 1);
        
        const t = {
            nrTicket,
            stato: document.getElementById('stato').value,
            tipo: document.getElementById('tipo').value,
            bloccante: document.getElementById('bloccante').value,
            priorita: document.getElementById('priorita').value,
            dataInserimento: document.getElementById('dataInserimento').value,
            ambito: document.getElementById('ambito').value,
            menu: document.getElementById('menu').value,
            titolo: document.getElementById('titolo').value,
            descrizione: document.getElementById('descrizione').value,
            inseritoDa: document.getElementById('inseritoDa').value,
            inCaricoA: document.getElementById('inCaricoA').value,
            dataInizioPrevista: document.getElementById('dataInizioPrevista').value,
            dataFinePrevista: document.getElementById('dataFinePrevista').value,
            dataRilascio: document.getElementById('dataRilascio').value,
            descrAttivita: document.getElementById('descrAttivita').value,
            // Mantieni le date di tracciamento se esistenti
            dataSegnalato: editTicketData.dataSegnalato || "",
            dataPresoInCarico: editTicketData.dataPresoInCarico || "",
            dataRilasciato: editTicketData.dataRilasciato || "",
            dataInTest: editTicketData.dataInTest || "",
            dataCompletato: editTicketData.dataCompletato || ""
        };

        // Aggiornamento date automatizzato al cambio stato (logica semplificata qui o nel trigger change)
        const now = new Date().toLocaleDateString('it-IT');
        if(t.stato === "Segnalato" && !t.dataSegnalato) t.dataSegnalato = now;
        if(t.stato === "Preso in carico" && !t.dataPresoInCarico) t.dataPresoInCarico = now;
        if(t.stato === "Rilasciato" && !t.dataRilasciato) t.dataRilasciato = now;
        if(t.stato === "In Test" && !t.dataInTest) t.dataInTest = now;
        if(t.stato === "Completato" && !t.dataCompletato) t.dataCompletato = now;

        const index = tickets.findIndex(tt => tt.nrTicket === nrTicket);
        if(index !== -1) tickets[index] = t; else tickets.push(t);

        const content = btoa(unescape(encodeURIComponent(JSON.stringify(tickets, null, 2))));
        const putRes = await fetch(`https://api.github.com/repos/${config.repo}/contents/ticket/2026/ticket2026.json`, {
            method: "PUT",
            headers: { Authorization: `token ${config.token}`, "Content-Type": "application/json" },
            body: JSON.stringify({ message: `Update Ticket #${nrTicket}`, content, sha })
        });

        if(putRes.ok) { alert("Ticket salvato!"); window.close(); }
        else throw new Error("Errore durante il salvataggio su GitHub");
    } catch(e) {
        alert(e.message);
    }
}

loadData();
</script>
</body>
</html>
