<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Ticket Form</title>
<script src="https://cdn.tailwindcss.com"></script>
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
</head>
<body class="bg-gray-100 p-6">
<div class="bg-white shadow-lg rounded-lg p-6 max-w-3xl mx-auto">
    <h1 class="text-3xl font-bold mb-6" id="ticketNumberDisplay">Nuovo Ticket</h1>
    <form id="ticketForm" class="space-y-4">

        <div class="grid grid-cols-2 gap-4">
            <div>
                <label class="font-bold text-gray-700">STATO</label>
                <select id="stato" class="w-full p-2 border rounded">
                    <option value="">-- Seleziona --</option>
                    <option value="Segnalato">Segnalato</option>
                    <option value="Preso in carico">Preso in carico</option>
                    <option value="In Test">In Test</option>
                    <option value="Rilasciato">Rilasciato</option>
                    <option value="Completato">Completato</option>
                </select>
            </div>
            <div>
                <label class="font-bold text-gray-700">Tipo</label>
                <select id="tipo" class="w-full p-2 border rounded">
                    <option value="Bug">Bug</option>
                    <option value="Miglioria">Miglioria</option>
                    <option value="Nuova richiesta">Nuova richiesta</option>
                </select>
            </div>
            <div>
                <label class="font-bold text-gray-700">Bloccante</label>
                <select id="bloccante" class="w-full p-2 border rounded">
                    <option value="Bloccante">Bloccante</option>
                    <option value="Non Bloccante">Non Bloccante</option>
                </select>
            </div>
            <div>
                <label class="font-bold text-gray-700">Priorità</label>
                <select id="priorita" class="w-full p-2 border rounded">
                    <option value="Alta">Alta</option>
                    <option value="Media">Media</option>
                    <option value="Bassa">Bassa</option>
                </select>
            </div>
        </div>

        <div class="grid grid-cols-2 gap-4">
            <div>
                <label class="font-bold text-gray-700">Data Inserimento</label>
                <input type="date" id="dataInserimento" class="w-full p-2 border rounded">
            </div>
            <div>
                <label class="font-bold text-gray-700">Ambito</label>
                <select id="ambito" class="w-full p-2 border rounded">
                    <option value="FASE1">FASE1</option>
                    <option value="FASE2">FASE2</option>
                    <option value="FASE3">FASE3</option>
                </select>
            </div>
            <div>
                <label class="font-bold text-gray-700">Menu</label>
                <select id="menu" class="w-full p-2 border rounded">
                    <option value="Pianificazione cantieri">Pianificazione cantieri</option>
                    <option value="Pianificazione Squadre">Pianificazione Squadre</option>
                    <option value="Da segnalare">Da segnalare</option>
                </select>
            </div>
        </div>

        <div>
            <label class="font-bold text-gray-700">Titolo</label>
            <input type="text" id="titolo" class="w-full p-2 border rounded">
        </div>
        <div>
            <label class="font-bold text-gray-700">Descrizione</label>
            <textarea id="descrizione" class="w-full p-2 border rounded"></textarea>
        </div>

        <div class="grid grid-cols-2 gap-4">
            <div>
                <label class="font-bold text-gray-700">Inserito da</label>
                <input type="text" id="inseritoDa" class="w-full p-2 border rounded">
            </div>
            <div>
                <label class="font-bold text-gray-700">In carico a</label>
                <input type="text" id="inCaricoA" class="w-full p-2 border rounded">
            </div>
        </div>

        <div class="grid grid-cols-3 gap-4">
            <div>
                <label class="font-bold text-gray-700">Data Inizio Prevista</label>
                <input type="date" id="dataInizioPrevista" class="w-full p-2 border rounded">
            </div>
            <div>
                <label class="font-bold text-gray-700">Data Fine Prevista</label>
                <input type="date" id="dataFinePrevista" class="w-full p-2 border rounded">
            </div>
            <div>
                <label class="font-bold text-gray-700">Data Rilascio</label>
                <input type="date" id="dataRilascio" class="w-full p-2 border rounded">
            </div>
        </div>

        <div>
            <label class="font-bold text-gray-700">Descrizione Attività</label>
            <textarea id="descrizioneAttivita" class="w-full p-2 border rounded"></textarea>
        </div>

        <button type="submit" class="mt-4 px-4 py-2 bg-green-600 text-white rounded hover:bg-green-700">Salva Ticket</button>
    </form>
</div>

<script>
let tickets = JSON.parse(localStorage.getItem('tickets')) || [];
let editIndex = localStorage.getItem('editIndex');
if(editIndex !== null) editIndex = parseInt(editIndex);

const now = new Date().toISOString().split('T')[0];
document.getElementById('dataInserimento').value = now;

if(editIndex !== null) {
    const t = tickets[editIndex];
    document.getElementById('ticketNumberDisplay').innerText = "Ticket #" + t.ticketNumber;
    document.getElementById('stato').value = t.stato;
    document.getElementById('tipo').value = t.tipo;
    document.getElementById('bloccante').value = t.bloccante;
    document.getElementById('priorita').value = t.priorita;
    document.getElementById('dataInserimento').value = t.dataInserimento;
    document.getElementById('ambito').value = t.ambito;
    document.getElementById('menu').value = t.menu;
    document.getElementById('titolo').value = t.titolo;
    document.getElementById('descrizione').value = t.descrizione;
    document.getElementById('inseritoDa').value = t.inseritoDa;
    document.getElementById('inCaricoA').value = t.inCaricoA;
    document.getElementById('dataInizioPrevista').value = t.dataInizioPrevista;
    document.getElementById('dataFinePrevista').value = t.dataFinePrevista;
    document.getElementById('dataRilascio').value = t.dataRilascio;
    document.getElementById('descrizioneAttivita').value = t.descrizioneAttivita;
}

document.getElementById('ticketForm').addEventListener('submit', function(e){
    e.preventDefault();
    const stato = document.getElementById('stato').value;

    const t = {
        ticketNumber: editIndex !== null ? tickets[editIndex].ticketNumber : (tickets.length + 1),
        stato: stato,
        tipo: document.getElementById('tipo').value,
        bloccante: document.getElementById('bloccante').value,
        priorita: document.getElementById('priorita').value,
        dataInserimento: document.getElementById('dataInserimento').value,
        ambito: document.getElementById('ambito').value,
        menu: document.getElementById('menu').value,
        titolo: document.getElementById('titolo').value,
        descrizione: document.getElementById('descrizione').value,
        inseritoDa: document.getElementById('inseritoDa').value,
        inCaricoA: document.getElementById('inCaricoA').value,
        dataInizioPrevista: document.getElementById('dataInizioPrevista').value,
        dataFinePrevista: document.getElementById('dataFinePrevista').value,
        dataRilascio: document.getElementById('dataRilascio').value,
        descrizioneAttivita: document.getElementById('descrizioneAttivita').value,
        dataSegnalato: (editIndex !== null && tickets[editIndex].dataSegnalato) || (stato==='Segnalato'?now:''),
        dataPresoInCarico: (editIndex !== null && tickets[editIndex].dataPresoInCarico) || (stato==='Preso in carico'?now:''),
        dataInTest: (editIndex !== null && tickets[editIndex].dataInTest) || (stato==='In Test'?now:''),
        dataCompletato: (editIndex !== null && tickets[editIndex].dataCompletato) || (stato==='Completato'?now:'')
    };

    if(editIndex !== null) tickets[editIndex] = t;
    else tickets.push(t);

    localStorage.setItem('tickets', JSON.stringify(tickets));
    alert('Ticket salvato con successo!');
    window.close();
});
</script>
</body>
</html>
