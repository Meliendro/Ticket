<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Ticket Form</title>
<script src="https://cdn.tailwindcss.com"></script>
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
</head>
<body class="bg-gray-100 p-6">

<div class="bg-white shadow-lg rounded-lg p-6 max-w-3xl mx-auto">
    <h1 class="text-3xl font-bold mb-6" id="ticketNumberDisplay">Nuovo Ticket</h1>

    <form id="ticketForm" class="space-y-4">
        <!-- (campo STATO, Tipo, Bloccante, PrioritÃ , ecc. come prima) -->
        <!-- NON CAMBIA la parte HTML dei campi, usiamo gli stessi ID -->
        <!-- ... -->
        <button type="submit" class="mt-4 px-4 py-2 bg-green-600 text-white rounded hover:bg-green-700">
            <i class="fas fa-save"></i> Salva
        </button>
    </form>
</div>

<script>
let tickets = [];
let fileSha = "";
let editIndex = localStorage.getItem('editIndex');
if(editIndex !== null) editIndex = parseInt(editIndex);

async function getConfig() {
    const config = JSON.parse(localStorage.getItem('gh_crm_config'));
    return config;
}

async function fetchTicketsFile() {
    const config = await getConfig();
    const url = `https://api.github.com/repos/${config.repo}/contents/2026/ticket2026.json`;
    const res = await fetch(url, {
        headers: { "Authorization": `token ${config.token}` }
    });
    const data = await res.json();
    if(res.ok) {
        fileSha = data.sha;
        tickets = JSON.parse(atob(data.content) || "[]");
    } else {
        tickets = [];
    }
}

async function initForm() {
    await fetchTicketsFile();

    document.getElementById('dataInserimento').value = new Date().toISOString().split('T')[0];

    if(editIndex !== null && tickets[editIndex]) {
        const t = tickets[editIndex];
        // riempi campi come prima...
        document.getElementById('ticketNumberDisplay').innerText = "Ticket #" + t.ticketNumber;
        // ...
    }
}
initForm();

document.getElementById('ticketForm').addEventListener('submit', async function(e){
    e.preventDefault();

    const config = await getConfig();
    const now = new Date().toISOString().split('T')[0];

    const t = {
        ticketNumber: editIndex !== null ? tickets[editIndex].ticketNumber : tickets.length + 1,
        stato: document.getElementById('stato').value,
        tipo: document.getElementById('tipo').value,
        bloccante: document.getElementById('bloccante').value,
        priorita: document.getElementById('priorita').value,
        dataInserimento: document.getElementById('dataInserimento').value,
        ambito: document.getElementById('ambito').value,
        menu: document.getElementById('menu').value,
        titolo: document.getElementById('titolo').value,
        descrizione: document.getElementById('descrizione').value,
        inseritoDa: document.getElementById('inseritoDa').value,
        inCaricoA: document.getElementById('inCaricoA').value,
        dataInizioPrevista: document.getElementById('dataInizioPrevista').value,
        dataFinePrevista: document.getElementById('dataFinePrevista').value,
        dataRilascio: document.getElementById('dataRilascio').value,
        descrizioneAttivita: document.getElementById('descrizioneAttivita').value,
        dataSegnalato: "",
        dataPresoInCarico: "",
        dataInTest: "",
        dataCompletato: ""
    };

    if(editIndex !== null) tickets[editIndex] = t;
    else tickets.push(t);

    const content = btoa(unescape(encodeURIComponent(JSON.stringify(tickets, null, 2))));
    const body = {
        message: editIndex !== null ? `Update ticket ${t.ticketNumber}` : `Create ticket ${t.ticketNumber}`,
        content: content,
        sha: fileSha
    };

    const url = `https://api.github.com/repos/${config.repo}/contents/2026/ticket2026.json`;
    const res = await fetch(url, {
        method: "PUT",
        headers: {
            "Authorization": `token ${config.token}`,
            "Content-Type": "application/json"
        },
        body: JSON.stringify(body)
    });

    if(res.ok) {
        alert("Ticket salvato su GitHub!");
        window.close();
    } else {
        alert("Errore salvataggio su GitHub");
    }
});
</script>

</body>
</html>
