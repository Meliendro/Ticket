<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Ticket Form</title>
<script src="https://cdn.tailwindcss.com"></script>
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
<style>
body { font-family: 'Segoe UI', sans-serif; padding:2rem; background:#f5f5f5;}
label { font-weight:bold; font-size:0.9rem; display:block; margin-top:0.5rem;}
input, select, textarea { width:100%; padding:0.5rem; margin-top:0.2rem; border-radius:0.5rem; border:1px solid #ccc;}
button { padding:0.6rem 1rem; margin-top:1rem; border-radius:0.5rem; font-weight:bold;}
</style>
</head>
<body>
<h1 id="ticketHeader" class="text-2xl font-bold mb-4 text-center"></h1>
<form id="ticketForm">
<label>Stato</label>
<select id="stato">
<option value="">-- seleziona --</option>
<option>Segnalato</option>
<option>Preso in carico</option>
<option>In Test</option>
<option>Completato</option>
</select>

<label>Tipo</label>
<select id="tipo">
<option>Bug</option>
<option>Miglioria</option>
<option>Nuova richiesta</option>
</select>

<label>Bloccante</label>
<select id="bloccante">
<option>Bloccante</option>
<option>Non Bloccante</option>
</select>

<label>Priorit√†</label>
<select id="priorita">
<option>Alta</option>
<option>Media</option>
<option>Bassa</option>
</select>

<label>Data Inserimento</label>
<input type="date" id="dataInserimento">

<label>Ambito</label>
<select id="ambito">
<option>FASE1</option>
<option>FASE2</option>
<option>FASE3</option>
</select>

<label>Menu</label>
<select id="menu">
<option>Pianificazione cantieri</option>
<option>Pianificazione Squadre</option>
<option>Da segnalare</option>
</select>

<label>Titolo</label>
<input type="text" id="titolo">

<label>Descrizione</label>
<textarea id="descrizione"></textarea>

<label>Inserito da</label>
<input type="text" id="inseritoDa">

<label>In carico a</label>
<input type="text" id="inCaricoA">

<label>Data Inizio Prevista</label>
<input type="date" id="dataInizioPrevista">

<label>Data Fine Prevista</label>
<input type="date" id="dataFinePrevista">

<label>Data Rilascio</label>
<input type="date" id="dataRilascio">

<label>Descrizione Soluzione</label>
<textarea id="descrizioneSoluzione"></textarea>

<button type="submit" class="bg-red-600 text-white w-full">Salva Ticket</button>
</form>

<script>
// Configurazione GitHub
let repoPath = 'ticket/2026/ticket2026.json';
let token = prompt("Inserisci il token GitHub per leggere/scrivere il file JSON");

let tickets = [];
let editIndex = localStorage.getItem('editTicketIndex');
let editTicketData = localStorage.getItem('editTicketData');

const fields = ['stato','tipo','bloccante','priorita','dataInserimento','ambito','menu','titolo','descrizione','inseritoDa','inCaricoA','dataInizioPrevista','dataFinePrevista','dataRilascio','descrizioneSoluzione'];

if(editTicketData){
    const ticket = JSON.parse(editTicketData);
    document.getElementById('ticketHeader').innerText = 'Modifica Ticket: ' + ticket.nrTicket;
    fields.forEach(f=>{
        if(ticket[f]!==undefined) document.getElementById(f).value = ticket[f];
    });
} else {
    document.getElementById('ticketHeader').innerText = 'Nuovo Ticket';
    document.getElementById('dataInserimento').valueAsDate = new Date();
}

async function fetchTickets() {
    try {
        const res = await fetch(`https://api.github.com/repos/YOUR_USER/YOUR_REPO/contents/${repoPath}`,{
            headers: { "Authorization": `token ${token}` }
        });
        if(res.ok){
            const data = await res.json();
            tickets = JSON.parse(decodeURIComponent(escape(atob(data.content))));
        } else { alert("Errore caricamento tickets"); }
    } catch(e){ console.error(e);}
}

document.getElementById('ticketForm').onsubmit = async function(e){
    e.preventDefault();
    const ticket = {};
    fields.forEach(f=> ticket[f] = document.getElementById(f).value);
    if(editTicketData){
        ticket.nrTicket = JSON.parse(editTicketData).nrTicket;
        tickets[editIndex] = ticket;
    } else {
        ticket.nrTicket = tickets.length>0? tickets[tickets.length-1].nrTicket+1 : 1;
        tickets.push(ticket);
    }

    const content = btoa(unescape(encodeURIComponent(JSON.stringify(tickets,null,2))));
    const body = { message: editTicketData?'Modifica Ticket':'Nuovo Ticket', content };
    const url = `https://api.github.com/repos/YOUR_USER/YOUR_REPO/contents/${repoPath}`;
    const sha = editTicketData? JSON.parse(await (await fetch(url,{headers:{"Authorization":`token ${token}`}})).text()).sha : undefined;
    if(sha) body['sha'] = sha;

    const res = await fetch(url,{method:'PUT', headers:{"Authorization":`token ${token}`,"Content-Type":"application/json"}, body:JSON.stringify(body)});
    if(res.ok){
        alert('Ticket salvato!');
        window.close();
    } else alert('Errore salvataggio');
}

fetchTickets();
</script>
</body>
</html>
