<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Inserimento Ticket</title>
<script src="https://cdn.tailwindcss.com"></script>
<style>
body { font-family: 'Segoe UI', sans-serif; background-color: #f3f4f6; }
.glass-panel { background: rgba(255,255,255,0.95); backdrop-filter: blur(12px); border-radius: 1rem; padding: 1rem; margin: 1rem; max-width: 800px; }
label { font-size:0.8rem; font-weight:bold; display:block; margin-top:0.5rem; }
input, select, textarea { width:100%; padding:0.4rem; border-radius:0.3rem; border:1px solid #ddd; margin-top:0.2rem; font-size:0.85rem; }
button { margin-top:1rem; background-color: #3b82f6; color:white; padding:0.5rem 1rem; border-radius:0.3rem; }
</style>
</head>
<body class="p-4">

<div class="glass-panel">
<h1 class="text-xl font-bold mb-4" id="titoloForm">Nuovo Ticket</h1>
<form id="ticketForm">
<label>Stato</label>
<select id="stato">
    <option value="" selected>Seleziona Stato</option>
    <option value="Segnalato">Segnalato</option>
    <option value="Preso in carico">Preso in carico</option>
    <option value="In Test">In Test</option>
    <option value="Rilasciato">Rilasciato</option>
    <option value="Completato">Completato</option>
</select>

<label>Tipo</label>
<select id="tipo">
    <option>Bug</option>
    <option>Miglioria</option>
    <option>Nuova richiesta</option>
</select>

<label>Priorità</label>
<select id="priorita">
    <option>Alta</option>
    <option>Media</option>
    <option>Bassa</option>
</select>

<label>Data Inserimento</label>
<input type="date" id="data_inserimento">

<label>Ambito</label>
<select id="ambito">
    <option>FASE1</option>
    <option>FASE2</option>
    <option>FASE3</option>
</select>

<label>Menu</label>
<select id="menu">
    <option>Pianificazione cantieri</option>
    <option>Pianificazione Squadre</option>
    <option>Da segnalare</option>
</select>

<label>Titolo</label>
<input type="text" id="titolo_input">

<label>Descrizione</label>
<textarea id="descrizione" rows="3"></textarea>

<label>Inserito da</label>
<input type="text" id="inserito_da">

<label>In carico a</label>
<input type="text" id="in_carico_a">

<label>Data inizio prevista attività</label>
<input type="date" id="data_inizio_prevista">

<label>Data fine prevista attività</label>
<input type="date" id="data_fine_prevista">

<label>Data rilascio</label>
<input type="date" id="data_rilascio">

<label>Descrizione attività di soluzione</label>
<textarea id="descrizione_soluzione" rows="2"></textarea>

<button type="submit">Salva Ticket</button>
</form>
</div>

<script>
// gestione edit
const urlParams = new URLSearchParams(window.location.search);
let editIndex = urlParams.has('edit') ? parseInt(urlParams.get('edit')) : null;
let ticketData = editIndex!==null && window.opener ? window.opener.tickets[editIndex] : null;

const form = document.getElementById('ticketForm');
form.data_inserimento.valueAsDate = new Date();

// se edit inizializza campi
if(ticketData){
    document.getElementById('titoloForm').innerText = 'Modifica Ticket';
    form.stato.value = ticketData.stato;
    form.tipo.value = ticketData.tipo;
    form.priorita.value = ticketData.priorita;
    form.data_inserimento.value = ticketData.data_inserimento;
    form.ambito.value = ticketData.ambito;
    form.menu.value = ticketData.menu;
    form.titolo_input.value = ticketData.titolo;
    form.descrizione.value = ticketData.descrizione;
    form.inserito_da.value = ticketData.inserito_da;
    form.in_carico_a.value = ticketData.in_carico_a;
    form.data_inizio_prevista.value = ticketData.data_inizio_prevista;
    form.data_fine_prevista.value = ticketData.data_fine_prevista;
    form.data_rilascio.value = ticketData.data_rilascio;
    form.descrizione_soluzione.value = ticketData.descrizione_soluzione;
}

// date automatiche per stato
const statoSelect = document.getElementById('stato');
statoSelect.addEventListener('change', ()=>{
    const now = new Date().toISOString().split('T')[0];
    ticketData = ticketData || {};
    switch(statoSelect.value){
        case 'Segnalato': if(!ticketData.data_segnalato) ticketData.data_segnalato = now; break;
        case 'Preso in carico': if(!ticketData.data_preso_in_carico) ticketData.data_preso_in_carico = now; break;
        case 'In Test': if(!ticketData.data_in_test) ticketData.data_in_test = now; break;
        case 'Rilasciato': if(!ticketData.data_rilasciato) ticketData.data_rilasciato = now; break;
        case 'Completato': if(!ticketData.data_completato) ticketData.data_completato = now; break;
    }
});

form.addEventListener('submit', function(e){
    e.preventDefault();
    const ticket = {
        stato: form.stato.value,
        tipo: form.tipo.value,
        priorita: form.priorita.value,
        data_inserimento: form.data_inserimento.value,
        ambito: form.ambito.value,
        menu: form.menu.value,
        titolo: form.titolo_input.value,
        descrizione: form.descrizione.value,
        inserito_da: form.inserito_da.value,
        in_carico_a: form.in_carico_a.value,
        data_inizio_prevista: form.data_inizio_prevista.value,
        data_fine_prevista: form.data_fine_prevista.value,
        data_rilascio: form.data_rilascio.value,
        descrizione_soluzione: form.descrizione_soluzione.value,
        data_segnalato: ticketData?.data_segnalato || null,
        data_preso_in_carico: ticketData?.data_preso_in_carico || null,
        data_in_test: ticketData?.data_in_test || null,
        data_rilasciato: ticketData?.data_rilasciato || null,
        data_completato: ticketData?.data_completato || null
    };

    if(window.opener && !window.opener.closed){
        window.opener.riceviTicket(ticket, editIndex);
        alert("Ticket salvato con successo!");
        window.close();
    } else {
        alert("Errore: finestra principale non trovata.");
    }
});
</script>

</body>
</html>
